<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>当Hugo遇上AVIF，优化图片加载 | 流动</title><meta name=keywords content="博客优化,hugo,avif,imagemagic,github"><meta name=description content="


		


这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。"><meta name=author content="Liudon"><link rel=canonical href=https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/><link crossorigin=anonymous href=../../assets/css/stylesheet.c2b4102602461aaea01497bf2f89d3d4096e9005f6ac8a7e60b27e335724b916.css integrity="sha256-wrQQJgJGGq6gFJe/L4nT1AlukAX2rIp+YLJ+M1ckuRY=" rel="preload stylesheet" as=style><link rel=icon href=https://liudon.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://liudon.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://liudon.com/favicon-32x32.png><link rel=apple-touch-icon href=https://liudon.com/apple-touch-icon.png><link rel=mask-icon href=https://liudon.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=google-site-verification content="rJrwFlRtYvRvSMxmD-zlGY6ozg6aDFMkfavno3ms5Ew"><meta name=google-adsense-account content="ca-pub-4739645989170648"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4739645989170648" crossorigin=anonymous></script><meta property="og:url" content="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/"><meta property="og:site_name" content="流动"><meta property="og:title" content="当Hugo遇上AVIF，优化图片加载"><meta property="og:description" content=" 这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-09-30T22:01:45+08:00"><meta property="article:modified_time" content="2024-09-30T22:01:45+08:00"><meta property="article:tag" content="博客优化"><meta property="article:tag" content="Hugo"><meta property="article:tag" content="Avif"><meta property="article:tag" content="Imagemagic"><meta property="article:tag" content="Github"><meta name=twitter:card content="summary"><meta name=twitter:title content="当Hugo遇上AVIF，优化图片加载"><meta name=twitter:description content="


		


这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://liudon.com/posts/"},{"@type":"ListItem","position":2,"name":"当Hugo遇上AVIF，优化图片加载","item":"https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"当Hugo遇上AVIF，优化图片加载","name":"当Hugo遇上AVIF，优化图片加载","description":" 这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。\n","keywords":["博客优化","hugo","avif","imagemagic","github"],"articleBody":" 这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。\n背景 AVIF是什么？\nAVIF（AV1 Image File Format）是一种基于AV1视频编码标准的图像文件格式。\nA modern image format based on the AV1 video format.\nAVIF generally has better compression than WebP, JPEG, PNG and GIF and is designed to supersede them.\n在2024年，绝大部分浏览器都已经支持了AVIF格式。\nImageMagick是什么？\nImageMagick® is a free, open-source software suite, used for editing and manipulating digital images.\nIt can be used to create, edit, compose, or convert bitmap images, and supports a wide range of file formats, including JPEG, PNG, GIF, TIFF, and Ultra HDR.\nImageMagick是一款用于图像处理的一个工具。\n对比 AVIF说的这么好，我们来验证对比一下。\n对于一张PNG的图片，使用ImageMagick分别生成WEBP和AVIF格式的图片，文件大小如下：\n-rw-r--r--@ 1 liudon staff 1.1M 9 29 23:02 20240922-170856.png -rw-r--r--@ 1 liudon staff 15K 9 29 23:08 20240922-170856.png.avif -rw-r--r--@ 1 liudon staff 25K 9 29 23:07 20240922-170856.png.webp WEBP比PNG要节省90%左右，AVIF要比WEBP再小40%左右。\n效果出奇的好，开搞吧。\n使用 1. 生成AVIF文件 博客使用了Github Workflow来进行部署，所以生成ImageMagick的工作也就放在了Github Workflow上。\n- name: Compress Image run: | sudo apt-get update sudo apt-get install -y imagemagick libheif-dev find ./content/posts/ -type f \\( -name \"*.jpg\" -o -name \"*.png\" -o -name \"*.jpeg\" \\) -exec convert {} -resize 1080x\\\u003e -quality 75 -define webp:image-hint=photo {}_1080x.webp \\; find ./content/posts/ -type f \\( -name \"*.jpg\" -o -name \"*.png\" -o -name \"*.jpeg\" \\) -exec convert {} -resize 1080x\\\u003e {}_1080x.avif \\; 新增压缩图片步骤，同时生成WEBP和AVIF格式文件。\n含义说明，可以自行调整：\n-resize 1080x\u003e 表示缩放到1080宽，\u003e表示只有在原图宽大于1080时才进行缩放，小于不做处理。 -quality 75 表示处理后图片质量，值越小图越小，图片也越不清晰。 -define webp:image-hint=photo 这里是为了对齐Hugo自身的图片处理参数。 2. 使用AVIF文件 修改layouts/_default/_markup/render-image.html文件：\n{{- $respSizes := slice 1080 -}} {{- $dataSizes := \"(min-width: 768px) 1080px, 100vw\" -}} {{- $holder := \"GIP\" -}} {{- $hint := \"photo\" -}} {{- $filter := \"box\" -}} {{- $Destination := .Destination -}} {{- $Page := .Page -}} {{- $Text := .Text -}} {{- $Title := .Title -}} {{- $responsiveImages := (.Page.Params.responsiveImages | default site.Params.responsiveImages) | default true }} {{ with $src := .Page.Resources.GetMatch .Destination }} {{- if $responsiveImages -}} {{- $imageTypes := slice -}} {{- if and hugo.IsExtended (ne $src.MediaType.Type \"image/webp\") -}} {{- $imageTypes = $imageTypes | append \"avif\" -}} {{- $imageTypes = $imageTypes | append \"webp\" -}} {{- end -}} {{- if gt (index $respSizes 0) $src.Width -}} {{- $respSizes = slice $src.Width -}} {{- end -}} \u003cpicture\u003e {{- range $imageType := $imageTypes -}} \u003csource type=\"image/{{ $imageType }}\" srcset=\" {{- $compressedImage := printf \"%s_1080x.%s\" $Destination $imageType -}} {{- $cmSrc := $Page.Resources.GetMatch $compressedImage -}} {{- if $cmSrc -}} {{ $cmSrc.RelPermalink | absURL}} 1080w {{- else -}} {{ if ne $imageType \"avif\" }} {{- with $respSizes -}} {{- range $i, $e := . -}} {{- if ge $src.Width . -}} {{- if $i }}, {{ end -}}{{- ($src.Resize (print . \"x \" $imageType \" \" $filter) ).RelPermalink | absURL}} {{ . }}w {{- end -}} {{- end -}} {{- end -}} {{ end }} {{- end -}}\" sizes=\"{{ $dataSizes }}\" /\u003e {{- end -}} \u003cimg src=\"{{ $Destination | safeURL }}\" width=\"{{ .Width }}\" height=\"{{ .Height }}\" alt=\"{{ $Text }}\" title=\"{{ $Title }}\" loading=\"lazy\" /\u003e \u003c/picture\u003e {{- else }} \u003cimg src=\"{{ $Destination | safeURL }}\" width=\"{{ $src.Width }}\" height=\"{{ $src.Height }}\" alt=\"{{ $Text }}\" title=\"{{ $Title }}\" loading=\"lazy\" /\u003e {{- end }} {{ end }} 这里如果AVIF/WEBP文件已经存在，那么直接使用对应文件（注意：我这里都是生成的1080宽，如果你有调整记得一起调整）；\n否则会使用Hugo自身的Image Processing生成对应格式文件。\n效果 优化前：\n优化后：\n从WEBP切换到AVIF，文件大小减少了30%左右。\n哈哈，太棒了，效果杠杠滴。\n唯一的缺点就是每次都是全量生成图片，Workflow执行略久些（我的要5分钟左右），这里后面再优化。\n从23年11月开始有的想法，在24年9月最后一天终于实现了。🎉🎉🎉\n","wordCount":"1249","inLanguage":"en","datePublished":"2024-09-30T22:01:45+08:00","dateModified":"2024-09-30T22:01:45+08:00","author":{"@type":"Person","name":"Liudon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/"},"publisher":{"@type":"Organization","name":"流动","logo":{"@type":"ImageObject","url":"https://liudon.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://liudon.com/ accesskey=h title="流动 (Alt + H)">流动</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://liudon.com/ title=Home><span>Home</span></a></li><li><a href=https://liudon.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://workout.liudon.com title=Workouts><span>Workouts</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://liudon.com/about/ title=About><span>About</span></a></li><li><a href=https://liudon.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">当Hugo遇上AVIF，优化图片加载</h1><div class=post-meta><span title='2024-09-30 22:01:45 +0800 +0800'>2024-09-30</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;1249 words&nbsp;·&nbsp;Liudon</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li><li><a href=#%e5%af%b9%e6%af%94 aria-label=对比>对比</a></li><li><a href=#%e4%bd%bf%e7%94%a8 aria-label=使用>使用</a><ul><li><a href=#1-%e7%94%9f%e6%88%90avif%e6%96%87%e4%bb%b6 aria-label="1. 生成AVIF文件">1. 生成AVIF文件</a></li><li><a href=#2-%e4%bd%bf%e7%94%a8avif%e6%96%87%e4%bb%b6 aria-label="2. 使用AVIF文件">2. 使用AVIF文件</a></li></ul></li><li><a href=#%e6%95%88%e6%9e%9c aria-label=效果>效果</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><picture><source type=image/avif srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/avif-on-hugo.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/avif-on-hugo.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=avif-on-hugo.png width=1080 height=328 alt=avif-on-hugo title loading=lazy></picture></p><p>这篇文章会介绍基于Github Workflow使用ImageMagick生成AVIF图片，来优化Hugo站点的加载速度。</p><h2 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h2><p>AVIF是什么？</p><blockquote><p>AVIF（AV1 Image File Format）是一种基于AV1视频编码标准的图像文件格式。</p><p>A modern image format based on the AV1 video format.</p><p>AVIF generally has better compression than WebP, JPEG, PNG and GIF and is designed to supersede them.</p></blockquote><p><picture><source type=image/avif srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/support.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/support.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=support.png width=1080 height=518 alt="browser support avif" title loading=lazy></picture></p><p>在2024年，绝大部分浏览器都已经支持了AVIF格式。</p><p>ImageMagick是什么？</p><blockquote><p>ImageMagick® is a free, open-source software suite, used for editing and manipulating digital images.</p><p>It can be used to create, edit, compose, or convert bitmap images, and supports a wide range of file formats, including JPEG, PNG, GIF, TIFF, and Ultra HDR.</p></blockquote><p>ImageMagick是一款用于图像处理的一个工具。</p><h2 id=对比>对比<a hidden class=anchor aria-hidden=true href=#对比>#</a></h2><p>AVIF说的这么好，我们来验证对比一下。</p><p>对于一张PNG的图片，使用ImageMagick分别生成WEBP和AVIF格式的图片，文件大小如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>-rw-r--r--@  1 liudon  staff   1.1M  9 29 23:02 20240922-170856.png
</span></span><span style=display:flex><span>-rw-r--r--@  1 liudon  staff    15K  9 29 23:08 20240922-170856.png.avif
</span></span><span style=display:flex><span>-rw-r--r--@  1 liudon  staff    25K  9 29 23:07 20240922-170856.png.webp
</span></span></code></pre></div><p>WEBP比PNG要节省90%左右，AVIF要比WEBP再小40%左右。</p><p>效果出奇的好，开搞吧。</p><h2 id=使用>使用<a hidden class=anchor aria-hidden=true href=#使用>#</a></h2><h3 id=1-生成avif文件>1. 生成AVIF文件<a hidden class=anchor aria-hidden=true href=#1-生成avif文件>#</a></h3><p>博客使用了Github Workflow来进行部署，所以生成ImageMagick的工作也就放在了Github Workflow上。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>- name: Compress Image
</span></span><span style=display:flex><span>run: |
</span></span><span style=display:flex><span>    sudo apt-get update
</span></span><span style=display:flex><span>    sudo apt-get install -y imagemagick libheif-dev
</span></span><span style=display:flex><span>    find ./content/posts/ -type f \( -name &#34;*.jpg&#34; -o -name &#34;*.png&#34; -o -name &#34;*.jpeg&#34; \) -exec convert {} -resize 1080x\&gt; -quality 75 -define webp:image-hint=photo {}_1080x.webp \;
</span></span><span style=display:flex><span>    find ./content/posts/ -type f \( -name &#34;*.jpg&#34; -o -name &#34;*.png&#34; -o -name &#34;*.jpeg&#34; \) -exec convert {} -resize 1080x\&gt; {}_1080x.avif \;
</span></span></code></pre></div><p>新增压缩图片步骤，同时生成WEBP和AVIF格式文件。</p><p>含义说明，可以自行调整：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>-resize 1080x&gt; 表示缩放到1080宽，&gt;表示只有在原图宽大于1080时才进行缩放，小于不做处理。
</span></span><span style=display:flex><span>-quality 75 表示处理后图片质量，值越小图越小，图片也越不清晰。
</span></span><span style=display:flex><span>-define webp:image-hint=photo 这里是为了对齐Hugo自身的图片处理参数。
</span></span></code></pre></div><h3 id=2-使用avif文件>2. 使用AVIF文件<a hidden class=anchor aria-hidden=true href=#2-使用avif文件>#</a></h3><p>修改<code>layouts/_default/_markup/render-image.html</code>文件：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>respSizes :<span style=color:#f92672>=</span> slice <span style=color:#ae81ff>1080</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>dataSizes :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;(min-width: 768px) 1080px, 100vw&#34;</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>holder :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;GIP&#34;</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>hint :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;photo&#34;</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>filter :<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;box&#34;</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>Destination :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span>Destination <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>Page :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span>Page <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>Text :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span>Text <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>Title :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span>Title <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>responsiveImages :<span style=color:#f92672>=</span> (<span style=color:#f92672>.</span>Page<span style=color:#f92672>.</span>Params<span style=color:#f92672>.</span>responsiveImages <span style=color:#f92672>|</span> default site<span style=color:#f92672>.</span>Params<span style=color:#f92672>.</span>responsiveImages) <span style=color:#f92672>|</span> default true }}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{{ with <span style=color:#f92672>$</span>src :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span>Page<span style=color:#f92672>.</span>Resources<span style=color:#f92672>.</span>GetMatch <span style=color:#f92672>.</span>Destination }}
</span></span><span style=display:flex><span>	{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>$</span>responsiveImages <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>imageTypes :<span style=color:#f92672>=</span> slice <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>and</span> hugo<span style=color:#f92672>.</span>IsExtended (ne <span style=color:#f92672>$</span>src<span style=color:#f92672>.</span>MediaType<span style=color:#f92672>.</span>Type <span style=color:#e6db74>&#34;image/webp&#34;</span>) <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>imageTypes <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>imageTypes <span style=color:#f92672>|</span> append <span style=color:#e6db74>&#34;avif&#34;</span> <span style=color:#f92672>-</span>}} <span style=color:#f92672>&lt;!--</span> avif need the first <span style=color:#f92672>--&gt;</span>
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>imageTypes <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>imageTypes <span style=color:#f92672>|</span> append <span style=color:#e6db74>&#34;webp&#34;</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> gt (index <span style=color:#f92672>$</span>respSizes <span style=color:#ae81ff>0</span>) <span style=color:#f92672>$</span>src<span style=color:#f92672>.</span>Width <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>respSizes <span style=color:#f92672>=</span> slice <span style=color:#f92672>$</span>src<span style=color:#f92672>.</span>Width <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;</span>picture<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> range <span style=color:#f92672>$</span>imageType :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>imageTypes <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			<span style=color:#f92672>&lt;</span>source type<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;image/{{ $imageType }}&#34;</span> srcset<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>compressedImage :<span style=color:#f92672>=</span> printf <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>_1080x.</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#34;</span> <span style=color:#f92672>$</span>Destination <span style=color:#f92672>$</span>imageType <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#f92672>$</span>cmSrc :<span style=color:#f92672>=</span> <span style=color:#f92672>$</span>Page<span style=color:#f92672>.</span>Resources<span style=color:#f92672>.</span>GetMatch <span style=color:#f92672>$</span>compressedImage <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>$</span>cmSrc <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>                <span style=color:#f92672>&lt;!--</span>avif<span style=color:#f92672>/</span>webp file exist<span style=color:#f92672>--&gt;</span>
</span></span><span style=display:flex><span>				{{ <span style=color:#f92672>$</span>cmSrc<span style=color:#f92672>.</span>RelPermalink <span style=color:#f92672>|</span> absURL}} <span style=color:#ae81ff>1080</span>w
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>else</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>				<span style=color:#f92672>&lt;!--</span> hugo <span style=color:#f92672>not</span> support avif format <span style=color:#f92672>--&gt;</span>
</span></span><span style=display:flex><span>				{{ <span style=color:#66d9ef>if</span> ne <span style=color:#f92672>$</span>imageType <span style=color:#e6db74>&#34;avif&#34;</span> }}
</span></span><span style=display:flex><span>					{{<span style=color:#f92672>-</span> with <span style=color:#f92672>$</span>respSizes <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>						{{<span style=color:#f92672>-</span> range <span style=color:#f92672>$</span>i, <span style=color:#f92672>$</span>e :<span style=color:#f92672>=</span> <span style=color:#f92672>.</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>							{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> ge <span style=color:#f92672>$</span>src<span style=color:#f92672>.</span>Width <span style=color:#f92672>.</span> <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>								{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>if</span> <span style=color:#f92672>$</span>i }}, {{ end <span style=color:#f92672>-</span>}}{{<span style=color:#f92672>-</span> (<span style=color:#f92672>$</span>src<span style=color:#f92672>.</span>Resize (print <span style=color:#f92672>.</span> <span style=color:#e6db74>&#34;x &#34;</span> <span style=color:#f92672>$</span>imageType <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>$</span>filter) )<span style=color:#f92672>.</span>RelPermalink <span style=color:#f92672>|</span> absURL}} {{ <span style=color:#f92672>.</span> }}w
</span></span><span style=display:flex><span>							{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>						{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>					{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>				{{ end }}
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}<span style=color:#e6db74>&#34; sizes=&#34;</span>{{ <span style=color:#f92672>$</span>dataSizes }}<span style=color:#e6db74>&#34; /&gt;</span>
</span></span><span style=display:flex><span>			{{<span style=color:#f92672>-</span> end <span style=color:#f92672>-</span>}}
</span></span><span style=display:flex><span>			<span style=color:#f92672>&lt;</span>img src<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Destination | safeURL }}&#34;</span> width<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ .Width }}&#34;</span> height<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ .Height }}&#34;</span> alt<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Text }}&#34;</span> title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Title }}&#34;</span> loading<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;lazy&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;/</span>picture<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	{{<span style=color:#f92672>-</span> <span style=color:#66d9ef>else</span> }}
</span></span><span style=display:flex><span>		<span style=color:#f92672>&lt;</span>img src<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Destination | safeURL }}&#34;</span> width<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $src.Width }}&#34;</span> height<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $src.Height }}&#34;</span> alt<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Text }}&#34;</span> title<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{{ $Title }}&#34;</span> loading<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;lazy&#34;</span> <span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span>	{{<span style=color:#f92672>-</span> end }}
</span></span><span style=display:flex><span>{{ end }}
</span></span></code></pre></div><p>这里如果AVIF/WEBP文件已经存在，那么直接使用对应文件（注意：我这里都是生成的1080宽，如果你有调整记得一起调整）；</p><p>否则会使用Hugo自身的Image Processing生成对应格式文件。</p><h2 id=效果>效果<a hidden class=anchor aria-hidden=true href=#效果>#</a></h2><p>优化前：</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/before.jpg_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/before.jpg_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=before.jpg width=1080 height=250 alt="optimize before" title loading=lazy></picture></p><p>优化后：</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/after.jpg_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/use-avif-to-optimize-images-on-hugo/after.jpg_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=after.jpg width=1080 height=266 alt="optimize after" title loading=lazy></picture></p><p>从WEBP切换到AVIF，文件大小减少了30%左右。</p><p>哈哈，太棒了，效果杠杠滴。</p><p>唯一的缺点就是每次都是全量生成图片，Workflow执行略久些（我的要5分钟左右），这里后面再优化。</p><p>从23年11月开始有的想法，在24年9月最后一天终于实现了。🎉🎉🎉</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://liudon.com/tags/%E5%8D%9A%E5%AE%A2%E4%BC%98%E5%8C%96/>博客优化</a></li><li><a href=https://liudon.com/tags/hugo/>Hugo</a></li><li><a href=https://liudon.com/tags/avif/>Avif</a></li><li><a href=https://liudon.com/tags/imagemagic/>Imagemagic</a></li><li><a href=https://liudon.com/tags/github/>Github</a></li></ul><nav class=paginav><a class=prev href=https://liudon.com/posts/climbing-mutianyu-great-wall-on-october-1st/><span class=title>« Prev</span><br><span>十月一日爬慕田峪长城</span>
</a><a class=next href=https://liudon.com/posts/blog-malicious-mirroring/><span class=title>Next »</span><br><span>博客被恶意镜像</span></a></nav></footer><div><div class=post_ads><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4739645989170648 data-ad-slot=5019102040 data-ad-format=auto data-full-width-responsive=true></ins><script>window.addEventListener("load",function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script></div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdnjs.cloudflare.com/ajax/libs/twikoo/1.6.41/twikoo.all.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script>twikoo.init({envId:"https://comment.liudon.com",el:"#tcomment",lang:"zh-CN",region:"ap-shanghai",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://liudon.com/>流动</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer style=margin-top:-20px;padding-top:0><span><a href=https://beian.miit.gov.cn target=_blank>京ICP备13029522号-2</a></span></footer><script src=//tokinx.github.io/ViewImage/view-image.min.js async></script><script>function initViewImage(){window.ViewImage&&ViewImage.init(".post-content img")}document.readyState==="complete"?initViewImage():window.addEventListener("load",initViewImage)</script><script>const host=window.location.host;host!=="blog.liudon.xyz"&&!host.startsWith("liudon.")&&!host.startsWith("localhost")&&!host.startsWith("127.0.0.1")&&(document.body.innerHTML=['<div style="margin: auto;">',"<h1>当前页面并非本人博客，即将在2秒后跳转到本人博客: https://liudon.com。</h1>","<br />","</div>"].join(""),document.body.style=["background-color: white;","color: black;","text-align: center;","font-size: 50px;","width: 100vw;","height: 100vh;","display: flex;"].join(""),setTimeout(()=>{window.location.href="https://liudon.com"},2e3))</script><script>enScroll=!1,enFdl=!1,extCurrent=0[0],filename=0[0],targetText=0[0],splitOrigin=0[0];const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-G9ZDJQN9E2",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?0[0]:enScroll==!0?0[0]:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return 0[0]},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":0[0],C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return 0[0]},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==0[0]&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://liudon.com/analytics/post",M=k({tid:j,_p:F(),v:"2",sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||0[0]).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||0[0],dr:doc.referrer||0[0],sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||0[0],"ep.file_name":t||0[0],"ep.link_text":n||0[0],"ep.link_url":o||0[0],_ss:O(),_dbg:A?1:0[0]}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>