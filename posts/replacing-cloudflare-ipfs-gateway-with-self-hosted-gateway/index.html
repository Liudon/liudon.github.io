<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway | 流动</title><meta name=keywords content="cloudflare,ipfs"><meta name=description content="背景
4月底的时候，Livid大佬提醒，Cloudflare应该是调整了IPFS Gateway网关策略，我的IPFS镜像博客无法访问了。
没查到Cloudflare的调整说明，不过还好IPFS官方也提供了公共网关gateway.ipfs.io，将域名解析改到官网网关。"><meta name=author content="Liudon"><link rel=canonical href=https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/><link crossorigin=anonymous href=../../assets/css/stylesheet.c2b4102602461aaea01497bf2f89d3d4096e9005f6ac8a7e60b27e335724b916.css integrity="sha256-wrQQJgJGGq6gFJe/L4nT1AlukAX2rIp+YLJ+M1ckuRY=" rel="preload stylesheet" as=style><link rel=icon href=https://liudon.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://liudon.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://liudon.com/favicon-32x32.png><link rel=apple-touch-icon href=https://liudon.com/apple-touch-icon.png><link rel=mask-icon href=https://liudon.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=google-site-verification content="rJrwFlRtYvRvSMxmD-zlGY6ozg6aDFMkfavno3ms5Ew"><meta name=google-adsense-account content="ca-pub-4739645989170648"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4739645989170648" crossorigin=anonymous></script><meta property="og:url" content="https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/"><meta property="og:site_name" content="流动"><meta property="og:title" content="搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway"><meta property="og:description" content="背景 4月底的时候，Livid大佬提醒，Cloudflare应该是调整了IPFS Gateway网关策略，我的IPFS镜像博客无法访问了。
没查到Cloudflare的调整说明，不过还好IPFS官方也提供了公共网关gateway.ipfs.io，将域名解析改到官网网关。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-05-22T21:20:20+08:00"><meta property="article:modified_time" content="2024-05-22T21:20:20+08:00"><meta property="article:tag" content="Cloudflare"><meta property="article:tag" content="Ipfs"><meta name=twitter:card content="summary"><meta name=twitter:title content="搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway"><meta name=twitter:description content="背景
4月底的时候，Livid大佬提醒，Cloudflare应该是调整了IPFS Gateway网关策略，我的IPFS镜像博客无法访问了。
没查到Cloudflare的调整说明，不过还好IPFS官方也提供了公共网关gateway.ipfs.io，将域名解析改到官网网关。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://liudon.com/posts/"},{"@type":"ListItem","position":2,"name":"搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway","item":"https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway","name":"搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway","description":"背景 4月底的时候，Livid大佬提醒，Cloudflare应该是调整了IPFS Gateway网关策略，我的IPFS镜像博客无法访问了。\n没查到Cloudflare的调整说明，不过还好IPFS官方也提供了公共网关gateway.ipfs.io，将域名解析改到官网网关。\n","keywords":["cloudflare","ipfs"],"articleBody":"背景 4月底的时候，Livid大佬提醒，Cloudflare应该是调整了IPFS Gateway网关策略，我的IPFS镜像博客无法访问了。\n没查到Cloudflare的调整说明，不过还好IPFS官方也提供了公共网关gateway.ipfs.io，将域名解析改到官网网关。\n但还是无法访问，被Cloudflare拦截了。\nError 1014 Ray ID: 887cc7fcfa2804bb • 2024-05-22 12:24:05 UTC CNAME Cross-User Banned What happened? You've requested a page on a website that is part of the Cloudflare network. The host is configured as a CNAME across accounts on Cloudflare, which is not allowed by Cloudflare's security policy. What can I do? If this is an R2 custom domain, it may still be initializing. If you have attempted to manually point a CNAME DNS record to your R2 bucket, you must do it using a custom domain. Refer to R2's documentation for details. Visit our website to learn more about Cloudflare. 这周在Discord群里，看到有人发消息，说是Cloudflare将下线IPFS Gateway网关服务。\nhttps://blog.cloudflare.com/cloudflares-public-ipfs-gateways-and-supporting-interplanetary-shipyard\nAll traffic using the cloudflare-ipfs.com or cf-ipfs.com hostname(s) will continue to work without interruption and be redirected to ipfs.io or dweb.link until August 14th, 2024, at which time the Cloudflare hostnames will no longer connect to IPFS and all users must switch the hostname they use to ipfs.io or dweb.link to ensure no service interruption takes place. If you are using either of the Cloudflare hostnames, please be sure to switch to one of the new ones as soon as possible ahead of the transition date to avoid any service interruptions!\n方案调研 经过一番搜索，找到了一篇自建IPFS Gateway网关的资料，里面用到了bifrost-gateway组件。\nTo run against a compatible, local trustless gateway provided by Kubo or IPFS Desktop: $ PROXY_GATEWAY_URL=\"http://127.0.0.1:8080\" ./bifrost-gateway 看文档，可以通过这个命令搭建一个自己的网关服务，同时支持DNSLink方式访问。\n太棒了，感觉可以自己搭一套网关，然后用Nginx反代对外提供服务。\n在之前将博客部署到星际文件系统(IPFS)文章中，已经通过Kubo搭建了一套本地IPFS服务。\n上机器验证一下可行性：\n启动Bifrost Gateway，网关默认地址为https://127.0.0.1:8081\n$ PROXY_GATEWAY_URL=\"http://127.0.0.1:8080\" ./bifrost-gateway 2024/05/22 20:54:00 Starting bifrost-gateway dev-build 2024/05/22 20:54:00 Proxy backend (PROXY_GATEWAY_URL) at http://127.0.0.1:8080 2024/05/22 20:54:00 BLOCK_CACHE_SIZE: 1024 2024/05/22 20:54:00 GRAPH_BACKEND: false 2024/05/22 20:54:00 Legacy RPC at /api/v0 (KUBO_RPC_URL) provided by http://127.0.0.1:5001 2024/05/22 20:54:00 Path gateway listening on http://127.0.0.1:8081 2024/05/22 20:54:00 Smoke test (JPG): http://127.0.0.1:8081/ipfs/bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi 2024/05/22 20:54:00 Subdomain gateway configured on dweb.link and http://localhost:8081 2024/05/22 20:54:00 Smoke test (Subdomain+DNSLink+UnixFS+HAMT): http://localhost:8081/ipns/en.wikipedia-on-ipfs.org/wiki/ 2024/05/22 20:54:00 Metrics exposed at http://127.0.0.1:8041/debug/metrics/prometheus 在另外一个终端下，执行命令\n$ curl 'http://127.0.0.1:8081/' -H\"Host:liudon.xyz\" -I HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Allow-Headers: Content-Type Access-Control-Allow-Headers: Range Access-Control-Allow-Headers: User-Agent Access-Control-Allow-Headers: X-Requested-With Access-Control-Allow-Methods: GET Access-Control-Allow-Methods: HEAD Access-Control-Allow-Methods: OPTIONS Access-Control-Allow-Origin: * Access-Control-Expose-Headers: Content-Length Access-Control-Expose-Headers: Content-Range Access-Control-Expose-Headers: X-Chunked-Output Access-Control-Expose-Headers: X-Ipfs-Path Access-Control-Expose-Headers: X-Ipfs-Roots Access-Control-Expose-Headers: X-Stream-Output Content-Length: 26283 Content-Type: text/html Etag: \"QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj\" Last-Modified: Wed, 22 May 2024 12:57:29 GMT X-Ipfs-Path: /ipns/liudon.xyz/ X-Ipfs-Roots: QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj Date: Wed, 22 May 2024 12:57:29 GMT 验证可行，不过我记得Kubo默认就有网关服务的，试一下直接通过Kubo默认网关的情况。\nKubo默认网关地址为http://127.0.0.1:8080，注意不要对外网提供8080端口访问，否则会被别人当成公共网关使用\n$ curl 'http://127.0.0.1:8080/' -H\"Host:liudon.xyz\" -I HTTP/1.1 200 OK Accept-Ranges: bytes Access-Control-Allow-Headers: Content-Type Access-Control-Allow-Headers: Range Access-Control-Allow-Headers: User-Agent Access-Control-Allow-Headers: X-Requested-With Access-Control-Allow-Methods: GET Access-Control-Allow-Origin: * Access-Control-Expose-Headers: Content-Length Access-Control-Expose-Headers: Content-Range Access-Control-Expose-Headers: X-Chunked-Output Access-Control-Expose-Headers: X-Ipfs-Path Access-Control-Expose-Headers: X-Ipfs-Roots Access-Control-Expose-Headers: X-Stream-Output Content-Length: 26283 Content-Type: text/html Etag: \"QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj\" Last-Modified: Wed, 22 May 2024 12:59:25 GMT X-Ipfs-Path: /ipns/liudon.xyz/ X-Ipfs-Roots: QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj Date: Wed, 22 May 2024 12:59:25 GMT 也是可以的，那就没必要多搞一套bifrost网关了。\n具体实现 通过Nginx反向代理转发到本地IPFS网关，只需要改一下解析就可以继续使用IPFS服务了。\nNginx反向代理 server { listen 443 ssl http2; server_name liudon.xyz; ssl_certificate /etc/nginx/ssl/liudon.xyz/fullchain.cer; ssl_certificate_key /etc/nginx/ssl/liudon.xyz/liudon.xyz.key; ssl_protocols TLSv1.2 TLSv1.3; ssl_ciphers 'TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384'; ssl_prefer_server_ciphers on; ssl_session_cache shared:SSL:10m; ssl_session_timeout 10m; location / { proxy_pass http://127.0.0.1:8080; proxy_set_header Host $host; // 注意这里要传递反代的域名信息，限制只能访问我们自己dnslink对应的资源 } access_log /var/log/nginx/liudon.xyz.access.log; error_log /var/log/nginx/liudon.xyz.error.log; } 申请Let's Encrypt证书，证书相关的就不多做介绍了，网上资料很多。\n更改DNS解析 原有的解析 类型：CNAME 名称：liudon.xyz 内容：cloudflare-ipfs.com 新的解析 类型：A 名称：liudon.xyz 内容：你的服务器公网IP 搞定，又可以继续白嫖IPFS服务了。\n","wordCount":"1262","inLanguage":"en","datePublished":"2024-05-22T21:20:20+08:00","dateModified":"2024-05-22T21:20:20+08:00","author":{"@type":"Person","name":"Liudon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/"},"publisher":{"@type":"Organization","name":"流动","logo":{"@type":"ImageObject","url":"https://liudon.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://liudon.com/ accesskey=h title="流动 (Alt + H)">流动</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://liudon.com/ title=Home><span>Home</span></a></li><li><a href=https://liudon.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://workout.liudon.com title=Workouts><span>Workouts</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://liudon.com/about/ title=About><span>About</span></a></li><li><a href=https://liudon.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">搭建自托管IPFS Gateway服务，替代Cloudflare的IPFS Gateway</h1><div class=post-meta><span title='2024-05-22 21:20:20 +0800 +0800'>2024-05-22</span>&nbsp;·&nbsp;3 min&nbsp;·&nbsp;1262 words&nbsp;·&nbsp;Liudon</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li><li><a href=#%e6%96%b9%e6%a1%88%e8%b0%83%e7%a0%94 aria-label=方案调研>方案调研</a></li><li><a href=#%e5%85%b7%e4%bd%93%e5%ae%9e%e7%8e%b0 aria-label=具体实现>具体实现</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h4 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h4><p>4月底的时候，Livid大佬提醒，<code>Cloudflare</code>应该是调整了<code>IPFS Gateway</code>网关策略，我的<a href=https://liudon.xyz>IPFS镜像博客</a>无法访问了。</p><p>没查到<code>Cloudflare</code>的调整说明，不过还好<code>IPFS</code>官方也提供了公共网关<code>gateway.ipfs.io</code>，将域名解析改到官网网关。</p><p>但还是无法访问，被<code>Cloudflare</code>拦截了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Error 1014 Ray ID: 887cc7fcfa2804bb • 2024-05-22 12:24:05 UTC
</span></span><span style=display:flex><span>CNAME Cross-User Banned
</span></span><span style=display:flex><span>What happened?
</span></span><span style=display:flex><span>You&#39;ve requested a page on a website that is part of the Cloudflare network. The host is configured as a CNAME across accounts on Cloudflare, which is not allowed by Cloudflare&#39;s security policy.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>What can I do?
</span></span><span style=display:flex><span>If this is an R2 custom domain, it may still be initializing. If you have attempted to manually point a CNAME DNS record to your R2 bucket, you must do it using a custom domain. Refer to R2&#39;s documentation for details.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Visit our website to learn more about Cloudflare.
</span></span></code></pre></div><p>这周在Discord群里，看到有人发消息，说是<code>Cloudflare</code>将下线<code>IPFS Gateway</code>网关服务。</p><p><a href=https://blog.cloudflare.com/cloudflares-public-ipfs-gateways-and-supporting-interplanetary-shipyard>https://blog.cloudflare.com/cloudflares-public-ipfs-gateways-and-supporting-interplanetary-shipyard</a></p><blockquote><p>All traffic using the cloudflare-ipfs.com or cf-ipfs.com hostname(s) will continue to work without interruption and be redirected to ipfs.io or dweb.link until August 14th, 2024, at which time the Cloudflare hostnames will no longer connect to IPFS and all users must switch the hostname they use to ipfs.io or dweb.link to ensure no service interruption takes place. If you are using either of the Cloudflare hostnames, please be sure to switch to one of the new ones as soon as possible ahead of the transition date to avoid any service interruptions!</p></blockquote><h4 id=方案调研>方案调研<a hidden class=anchor aria-hidden=true href=#方案调研>#</a></h4><p>经过一番搜索，找到了一篇<a href=https://railway.app/template/PhPjgz>自建IPFS Gateway网关的资料</a>，里面用到了<a href=https://github.com/ipfs/bifrost-gateway>bifrost-gateway</a>组件。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>To run against a compatible, local trustless gateway provided by Kubo or IPFS Desktop:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ PROXY_GATEWAY_URL=&#34;http://127.0.0.1:8080&#34; ./bifrost-gateway
</span></span></code></pre></div><p>看文档，可以通过这个命令搭建一个自己的网关服务，同时支持<code>DNSLink</code>方式访问。</p><p>太棒了，感觉可以自己搭一套网关，然后用<code>Nginx</code>反代对外提供服务。</p><p>在之前<a href=https://liudon.com/posts/deploy-blog-to-ipfs/>将博客部署到星际文件系统(IPFS)</a>文章中，已经通过<code>Kubo</code>搭建了一套本地<code>IPFS</code>服务。</p><p>上机器验证一下可行性：</p><ol><li><p>启动Bifrost Gateway，网关默认地址为<code>https://127.0.0.1:8081</code></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ PROXY_GATEWAY_URL=&#34;http://127.0.0.1:8080&#34; ./bifrost-gateway
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Starting bifrost-gateway dev-build
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Proxy backend (PROXY_GATEWAY_URL) at http://127.0.0.1:8080
</span></span><span style=display:flex><span>2024/05/22 20:54:00 BLOCK_CACHE_SIZE: 1024
</span></span><span style=display:flex><span>2024/05/22 20:54:00 GRAPH_BACKEND: false
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Legacy RPC at /api/v0 (KUBO_RPC_URL) provided by http://127.0.0.1:5001
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Path gateway listening on http://127.0.0.1:8081
</span></span><span style=display:flex><span>2024/05/22 20:54:00   Smoke test (JPG): http://127.0.0.1:8081/ipfs/bafybeigdyrzt5sfp7udm7hu76uh7y26nf3efuylqabf3oclgtqy55fbzdi
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Subdomain gateway configured on dweb.link and http://localhost:8081
</span></span><span style=display:flex><span>2024/05/22 20:54:00   Smoke test (Subdomain+DNSLink+UnixFS+HAMT): http://localhost:8081/ipns/en.wikipedia-on-ipfs.org/wiki/
</span></span><span style=display:flex><span>2024/05/22 20:54:00 Metrics exposed at http://127.0.0.1:8041/debug/metrics/prometheus
</span></span></code></pre></div></li><li><p>在另外一个终端下，执行命令</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ curl &#39;http://127.0.0.1:8081/&#39; -H&#34;Host:liudon.xyz&#34; -I
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: Content-Type
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: Range
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: User-Agent
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: X-Requested-With
</span></span><span style=display:flex><span>Access-Control-Allow-Methods: GET
</span></span><span style=display:flex><span>Access-Control-Allow-Methods: HEAD
</span></span><span style=display:flex><span>Access-Control-Allow-Methods: OPTIONS
</span></span><span style=display:flex><span>Access-Control-Allow-Origin: *
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: Content-Length
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: Content-Range
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Chunked-Output
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Ipfs-Path
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Ipfs-Roots
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Stream-Output
</span></span><span style=display:flex><span>Content-Length: 26283
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Etag: &#34;QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj&#34;
</span></span><span style=display:flex><span>Last-Modified: Wed, 22 May 2024 12:57:29 GMT
</span></span><span style=display:flex><span>X-Ipfs-Path: /ipns/liudon.xyz/
</span></span><span style=display:flex><span>X-Ipfs-Roots: QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj
</span></span><span style=display:flex><span>Date: Wed, 22 May 2024 12:57:29 GMT
</span></span></code></pre></div></li></ol><p>验证可行，不过我记得<code>Kubo</code>默认就有网关服务的，试一下直接通过<code>Kubo</code>默认网关的情况。</p><p><em>Kubo默认网关地址为http://127.0.0.1:8080，注意不要对外网提供8080端口访问，否则会被别人当成公共网关使用</em></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ curl &#39;http://127.0.0.1:8080/&#39; -H&#34;Host:liudon.xyz&#34; -I
</span></span><span style=display:flex><span>HTTP/1.1 200 OK
</span></span><span style=display:flex><span>Accept-Ranges: bytes
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: Content-Type
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: Range
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: User-Agent
</span></span><span style=display:flex><span>Access-Control-Allow-Headers: X-Requested-With
</span></span><span style=display:flex><span>Access-Control-Allow-Methods: GET
</span></span><span style=display:flex><span>Access-Control-Allow-Origin: *
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: Content-Length
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: Content-Range
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Chunked-Output
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Ipfs-Path
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Ipfs-Roots
</span></span><span style=display:flex><span>Access-Control-Expose-Headers: X-Stream-Output
</span></span><span style=display:flex><span>Content-Length: 26283
</span></span><span style=display:flex><span>Content-Type: text/html
</span></span><span style=display:flex><span>Etag: &#34;QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj&#34;
</span></span><span style=display:flex><span>Last-Modified: Wed, 22 May 2024 12:59:25 GMT
</span></span><span style=display:flex><span>X-Ipfs-Path: /ipns/liudon.xyz/
</span></span><span style=display:flex><span>X-Ipfs-Roots: QmebCXeD6XDB9xsVvX5Te91EeF5t7sk65A3adsLQ9bostj
</span></span><span style=display:flex><span>Date: Wed, 22 May 2024 12:59:25 GMT
</span></span></code></pre></div><p>也是可以的，那就没必要多搞一套bifrost网关了。</p><h4 id=具体实现>具体实现<a hidden class=anchor aria-hidden=true href=#具体实现>#</a></h4><p>通过<code>Nginx</code>反向代理转发到本地<code>IPFS</code>网关，只需要改一下解析就可以继续使用<code>IPFS</code>服务了。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/20240522210154.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/replacing-cloudflare-ipfs-gateway-with-self-hosted-gateway/20240522210154.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20240522210154.png width=904 height=1040 alt=方案 title loading=lazy></picture></p><ol><li><code>Nginx</code>反向代理</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span>server {
</span></span><span style=display:flex><span>    listen <span style=color:#ae81ff>443</span> ssl http2;
</span></span><span style=display:flex><span>    server_name liudon<span style=color:#f92672>.</span>xyz;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ssl_certificate <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>nginx<span style=color:#f92672>/</span>ssl<span style=color:#f92672>/</span>liudon<span style=color:#f92672>.</span>xyz<span style=color:#f92672>/</span>fullchain<span style=color:#f92672>.</span>cer;
</span></span><span style=display:flex><span>    ssl_certificate_key <span style=color:#f92672>/</span>etc<span style=color:#f92672>/</span>nginx<span style=color:#f92672>/</span>ssl<span style=color:#f92672>/</span>liudon<span style=color:#f92672>.</span>xyz<span style=color:#f92672>/</span>liudon<span style=color:#f92672>.</span>xyz<span style=color:#f92672>.</span>key;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ssl_protocols TLSv1<span style=color:#f92672>.</span><span style=color:#ae81ff>2</span> TLSv1<span style=color:#f92672>.</span><span style=color:#ae81ff>3</span>;
</span></span><span style=display:flex><span>    ssl_ciphers <span style=color:#e6db74>&#39;TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384&#39;</span>;
</span></span><span style=display:flex><span>    ssl_prefer_server_ciphers on;
</span></span><span style=display:flex><span>    ssl_session_cache shared:SSL:<span style=color:#ae81ff>10</span>m;
</span></span><span style=display:flex><span>    ssl_session_timeout <span style=color:#ae81ff>10</span>m;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    location <span style=color:#f92672>/</span> {
</span></span><span style=display:flex><span>            proxy_pass http:<span style=color:#f92672>//</span><span style=color:#ae81ff>127.0</span><span style=color:#f92672>.</span><span style=color:#ae81ff>0.1</span>:<span style=color:#ae81ff>8080</span>;
</span></span><span style=display:flex><span>            proxy_set_header Host <span style=color:#f92672>$</span>host; <span style=color:#f92672>//</span> <span style=color:#960050;background-color:#1e0010>注意这里要传递反代的域名信息，限制只能访问我们自己</span>dnslink对应的资源
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    access_log <span style=color:#f92672>/</span><span style=color:#66d9ef>var</span><span style=color:#f92672>/</span>log<span style=color:#f92672>/</span>nginx<span style=color:#f92672>/</span>liudon<span style=color:#f92672>.</span>xyz<span style=color:#f92672>.</span>access<span style=color:#f92672>.</span>log;
</span></span><span style=display:flex><span>    error_log <span style=color:#f92672>/</span><span style=color:#66d9ef>var</span><span style=color:#f92672>/</span>log<span style=color:#f92672>/</span>nginx<span style=color:#f92672>/</span>liudon<span style=color:#f92672>.</span>xyz<span style=color:#f92672>.</span>error<span style=color:#f92672>.</span>log;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>申请<code>Let's Encrypt</code>证书，证书相关的就不多做介绍了，网上资料很多。</p><ol start=2><li>更改DNS解析</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>原有的解析
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>类型：CNAME
</span></span><span style=display:flex><span>名称：liudon.xyz
</span></span><span style=display:flex><span>内容：cloudflare-ipfs.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>新的解析
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>类型：A
</span></span><span style=display:flex><span>名称：liudon.xyz
</span></span><span style=display:flex><span>内容：你的服务器公网IP
</span></span></code></pre></div><p>搞定，又可以继续白嫖<code>IPFS</code>服务了。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://liudon.com/tags/cloudflare/>Cloudflare</a></li><li><a href=https://liudon.com/tags/ipfs/>Ipfs</a></li></ul><nav class=paginav><a class=prev href=https://liudon.com/posts/solving-undeclared-name-any-requires-version-go1.18-or-later-compilation-error/><span class=title>« Prev</span><br><span>解决 "undeclared name: any (requires version go1.18 or later)" 编译错误</span>
</a><a class=next href=https://liudon.com/posts/the-cors-issue-with-302-redirect/><span class=title>Next »</span><br><span>302跳转的跨域问题(CORS)</span></a></nav></footer><div><div class=post_ads><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4739645989170648 data-ad-slot=5019102040 data-ad-format=auto data-full-width-responsive=true></ins><script>window.addEventListener("load",function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script></div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdnjs.cloudflare.com/ajax/libs/twikoo/1.6.41/twikoo.all.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script>twikoo.init({envId:"https://comment.liudon.com",el:"#tcomment",lang:"zh-CN",region:"ap-shanghai",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://liudon.com/>流动</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer style=margin-top:-20px;padding-top:0><span><a href=https://beian.miit.gov.cn target=_blank>京ICP备13029522号-2</a></span></footer><script src=//tokinx.github.io/ViewImage/view-image.min.js async></script><script>function initViewImage(){window.ViewImage&&ViewImage.init(".post-content img")}document.readyState==="complete"?initViewImage():window.addEventListener("load",initViewImage)</script><script>const host=window.location.host;host!=="blog.liudon.xyz"&&!host.startsWith("liudon.")&&!host.startsWith("localhost")&&!host.startsWith("127.0.0.1")&&(document.body.innerHTML=['<div style="margin: auto;">',"<h1>当前页面并非本人博客，即将在2秒后跳转到本人博客: https://liudon.com。</h1>","<br />","</div>"].join(""),document.body.style=["background-color: white;","color: black;","text-align: center;","font-size: 50px;","width: 100vw;","height: 100vh;","display: flex;"].join(""),setTimeout(()=>{window.location.href="https://liudon.com"},2e3))</script><script>enScroll=!1,enFdl=!1,extCurrent=0[0],filename=0[0],targetText=0[0],splitOrigin=0[0];const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-G9ZDJQN9E2",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?0[0]:enScroll==!0?0[0]:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return 0[0]},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":0[0],C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return 0[0]},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==0[0]&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://liudon.com/analytics/post",M=k({tid:j,_p:F(),v:"2",sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||0[0]).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||0[0],dr:doc.referrer||0[0],sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||0[0],"ep.file_name":t||0[0],"ep.link_text":n||0[0],"ep.link_url":o||0[0],_ss:O(),_dbg:A?1:0[0]}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>