<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Swoft 框架运行分析（二） —— AnnotationProcessor模块分析 | 流动</title><meta name=keywords content="Swoft"><meta name=description content="上一篇介绍了，SwoftApplication里定义了6个Processor对象。
protected function processors(): array
    {
        return [
            new EnvProcessor($this),
            new ConfigProcessor($this),
            new AnnotationProcessor($this),
            new BeanProcessor($this),
            new EventProcessor($this),
            new ConsoleProcessor($this),
        ];
    }
所有的Processor实现都在framework\src\Processor目录下。"><meta name=author content="Liudon"><link rel=canonical href=https://liudon.com/posts/swoft-anaotion-processor-analysis/><link crossorigin=anonymous href=../../assets/css/stylesheet.c2b4102602461aaea01497bf2f89d3d4096e9005f6ac8a7e60b27e335724b916.css integrity="sha256-wrQQJgJGGq6gFJe/L4nT1AlukAX2rIp+YLJ+M1ckuRY=" rel="preload stylesheet" as=style><link rel=icon href=https://liudon.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://liudon.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://liudon.com/favicon-32x32.png><link rel=apple-touch-icon href=https://liudon.com/apple-touch-icon.png><link rel=mask-icon href=https://liudon.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://liudon.com/posts/swoft-anaotion-processor-analysis/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=google-site-verification content="rJrwFlRtYvRvSMxmD-zlGY6ozg6aDFMkfavno3ms5Ew"><meta name=google-adsense-account content="ca-pub-4739645989170648"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4739645989170648" crossorigin=anonymous></script><meta property="og:url" content="https://liudon.com/posts/swoft-anaotion-processor-analysis/"><meta property="og:site_name" content="流动"><meta property="og:title" content="Swoft 框架运行分析（二） —— AnnotationProcessor模块分析"><meta property="og:description" content="上一篇介绍了，SwoftApplication里定义了6个Processor对象。
protected function processors(): array { return [ new EnvProcessor($this), new ConfigProcessor($this), new AnnotationProcessor($this), new BeanProcessor($this), new EventProcessor($this), new ConsoleProcessor($this), ]; } 所有的Processor实现都在framework\src\Processor目录下。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-08-29T19:11:04+08:00"><meta property="article:modified_time" content="2019-08-29T19:11:04+08:00"><meta property="article:tag" content="Swoft"><meta name=twitter:card content="summary"><meta name=twitter:title content="Swoft 框架运行分析（二） —— AnnotationProcessor模块分析"><meta name=twitter:description content="上一篇介绍了，SwoftApplication里定义了6个Processor对象。
protected function processors(): array
    {
        return [
            new EnvProcessor($this),
            new ConfigProcessor($this),
            new AnnotationProcessor($this),
            new BeanProcessor($this),
            new EventProcessor($this),
            new ConsoleProcessor($this),
        ];
    }
所有的Processor实现都在framework\src\Processor目录下。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://liudon.com/posts/"},{"@type":"ListItem","position":2,"name":"Swoft 框架运行分析（二） —— AnnotationProcessor模块分析","item":"https://liudon.com/posts/swoft-anaotion-processor-analysis/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Swoft 框架运行分析（二） —— AnnotationProcessor模块分析","name":"Swoft 框架运行分析（二） —— AnnotationProcessor模块分析","description":"上一篇介绍了，SwoftApplication里定义了6个Processor对象。\nprotected function processors(): array { return [ new EnvProcessor($this), new ConfigProcessor($this), new AnnotationProcessor($this), new BeanProcessor($this), new EventProcessor($this), new ConsoleProcessor($this), ]; } 所有的Processor实现都在framework\\src\\Processor目录下。\n","keywords":["Swoft"],"articleBody":"上一篇介绍了，SwoftApplication里定义了6个Processor对象。\nprotected function processors(): array { return [ new EnvProcessor($this), new ConfigProcessor($this), new AnnotationProcessor($this), new BeanProcessor($this), new EventProcessor($this), new ConsoleProcessor($this), ]; } 所有的Processor实现都在framework\\src\\Processor目录下。\nEnvProcessor，运行环境检查。\nConfigProcessor，配置相关。\nAnnotationProcessor，注解相关。\nBeanProcessor，Bean相关。\nEventProcessor，事件相关。\nConsoleProcessor，命令行输入相关。\n今天先讲一下AnnotationProcessor这个模块的实现。\n\u003c?php declare(strict_types=1); namespace Swoft\\Processor; use Exception; use Swoft\\Annotation\\AnnotationRegister; use Swoft\\Log\\Helper\\CLog; /** * Annotation processor * @since 2.0 */ class AnnotationProcessor extends Processor { /** * Handle annotation * * @return bool * @throws Exception */ public function handle(): bool { if (!$this-\u003eapplication-\u003ebeforeAnnotation()) { CLog::warning('Stop annotation processor by beforeAnnotation return false'); return false; } $app = $this-\u003eapplication; // Find AutoLoader classes. Parse and collect annotations. AnnotationRegister::load([ 'inPhar' =\u003e \\IN_PHAR, 'basePath' =\u003e $app-\u003egetBasePath(), 'notifyHandler' =\u003e [$this, 'notifyHandler'], 'disabledAutoLoaders' =\u003e $app-\u003egetDisabledAutoLoaders(), 'disabledPsr4Prefixes' =\u003e $app-\u003egetDisabledPsr4Prefixes(), ]); $stats = AnnotationRegister::getClassStats(); CLog::info( 'Annotations is scanned(autoloader %d, annotation %d, parser %d)', $stats['autoloader'], $stats['annotation'], $stats['parser'] ); return $this-\u003eapplication-\u003eafterAnnotation(); } /** * @param string $type * @param string $target * @see \\Swoft\\Annotation\\Resource\\AnnotationResource::load() */ public function notifyHandler(string $type, $target): void { switch ($type) { case 'excludeNs': CLog::debug('Exclude namespace %s', $target); break; case 'noLoaderFile': CLog::debug('No autoloader on %s', $target); break; case 'noLoaderClass': CLog::debug('Autoloader class not exist %s', $target); break; case 'findLoaderClass': CLog::debug('Find autoloader %s', $target); break; case 'addLoaderClass': CLog::debug('Parse autoloader %s', $target); break; case 'noExistClass': CLog::debug('Skip interface or trait %s', $target); break; } } } 核心逻辑调用AnnotationRegister类的load方法，定义如下。\n/** * Load annotation class * * @param array $config * * @throws AnnotationException * @throws ReflectionException */ public static function load(array $config = []): void { $resource = new AnnotationResource($config); $resource-\u003eload(); } 这里又调用了AnnotationResource类的load方法，定义如下。\n/** * Load annotation resource by find ClassLoader * * @throws AnnotationException * @throws ReflectionException */ public function load(): void { $prefixDirsPsr4 = $this-\u003eclassLoader-\u003egetPrefixesPsr4(); foreach ($prefixDirsPsr4 as $ns =\u003e $paths) { // Only scan namespaces if ($this-\u003eonlyNamespaces \u0026\u0026 !in_array($ns, $this-\u003eonlyNamespaces, true)) { $this-\u003enotify('excludeNs', $ns); continue; } // It is excluded psr4 prefix if ($this-\u003eisExcludedPsr4Prefix($ns)) { AnnotationRegister::registerExcludeNs($ns); $this-\u003enotify('excludeNs', $ns); continue; } // Find package/component loader class foreach ($paths as $path) { $loaderFile = $this-\u003egetAnnotationClassLoaderFile($path); if (!file_exists($loaderFile)) { $this-\u003enotify('noLoaderFile', $this-\u003eclearBasePath($path), $loaderFile); continue; } $loaderClass = $this-\u003egetAnnotationLoaderClassName($ns); if (!class_exists($loaderClass)) { $this-\u003enotify('noLoaderClass', $loaderClass); continue; } $loaderObject = new $loaderClass(); if (!$loaderObject instanceof LoaderInterface) { $this-\u003enotify('invalidLoader', $loaderFile); continue; } $this-\u003enotify('findLoaderClass', $this-\u003eclearBasePath($loaderFile)); // If is disable, will skip scan annotation classes if (!isset($this-\u003edisabledAutoLoaders[$loaderClass])) { AnnotationRegister::registerAutoLoaderFile($loaderFile); $this-\u003enotify('addLoaderClass', $loaderClass); $this-\u003eloadAnnotation($loaderObject); } // Storage auto loader to register AnnotationRegister::addAutoLoader($ns, $loaderObject); } } } 通过getPrefixesPsr4方法获取所有自动加载的命名空间和目录，遍历目录下的AutoLoader.php文件。\n通过registerAutoLoaderFile注册自动加载文件到AnnotationRegister对象上。\n然后调用了loadAnnotation方法，传入的是一个autoload对象。\n/** * Load annotations from an component loader config. * * @param LoaderInterface $loader * * @throws AnnotationException * @throws ReflectionException */ private function loadAnnotation(LoaderInterface $loader): void { $nsPaths = $loader-\u003egetPrefixDirs(); foreach ($nsPaths as $ns =\u003e $path) { $iterator = DirectoryHelper::recursiveIterator($path); /* @var SplFileInfo $splFileInfo */ foreach ($iterator as $splFileInfo) { $filePath = $splFileInfo-\u003egetPathname(); // $splFileInfo-\u003eisDir(); if (is_dir($filePath)) { continue; } $fileName = $splFileInfo-\u003egetFilename(); $extension = $splFileInfo-\u003egetExtension(); if ($this-\u003eloaderClassSuffix !== $extension || strpos($fileName, '.') === 0) { continue; } // It is exclude filename if (isset($this-\u003eexcludedFilenames[$fileName])) { AnnotationRegister::registerExcludeFilename($fileName); continue; } $suffix = sprintf('.%s', $this-\u003eloaderClassSuffix); $pathName = str_replace([$path, '/', $suffix], ['', '\\\\', ''], $filePath); $className = sprintf('%s%s', $ns, $pathName); // Fix repeat included file bug $autoload = in_array($filePath, $this-\u003eincludedFiles, true); // Will filtering: interfaces and traits if (!class_exists($className, !$autoload)) { $this-\u003enotify('noExistClass', $className); continue; } // Parse annotation $this-\u003eparseAnnotation($ns, $className); } } } 通过getPrefixDirs获取当前命名空间的目录，然后通过recursiveIterator遍历目录下的文件。\n排除目录和非.php结尾的文件，最后会调用parseAnnotation方法。\n/** * Parser annotation * * @param string $namespace * @param string $className * * @throws AnnotationException * @throws ReflectionException */ private function parseAnnotation(string $namespace, string $className): void { // Annotation reader $reflectionClass = new ReflectionClass($className); // Fix ignore abstract if ($reflectionClass-\u003eisAbstract()) { return; } $oneClassAnnotation = $this-\u003eparseOneClassAnnotation($reflectionClass); if (!empty($oneClassAnnotation)) { AnnotationRegister::registerAnnotation($namespace, $className, $oneClassAnnotation); } } 这里调用了parseOneClassAnnotation方法。\n/** * Parse an class annotation * * @param ReflectionClass $reflectionClass * * @return array * @throws AnnotationException * @throws ReflectionException */ private function parseOneClassAnnotation(ReflectionClass $reflectionClass): array { // Annotation reader $reader = new AnnotationReader(); $className = $reflectionClass-\u003egetName(); $oneClassAnnotation = []; $classAnnotations = $reader-\u003egetClassAnnotations($reflectionClass); // Register annotation parser foreach ($classAnnotations as $classAnnotation) { if ($classAnnotation instanceof AnnotationParser) { $this-\u003eregisterParser($className, $classAnnotation); return []; } } // Class annotation if (!empty($classAnnotations)) { $oneClassAnnotation['annotation'] = $classAnnotations; $oneClassAnnotation['reflection'] = $reflectionClass; } // Property annotation $reflectionProperties = $reflectionClass-\u003egetProperties(); foreach ($reflectionProperties as $reflectionProperty) { $propertyName = $reflectionProperty-\u003egetName(); $propertyAnnotations = $reader-\u003egetPropertyAnnotations($reflectionProperty); if (!empty($propertyAnnotations)) { $oneClassAnnotation['properties'][$propertyName]['annotation'] = $propertyAnnotations; $oneClassAnnotation['properties'][$propertyName]['reflection'] = $reflectionProperty; } } // Method annotation $reflectionMethods = $reflectionClass-\u003egetMethods(); foreach ($reflectionMethods as $reflectionMethod) { $methodName = $reflectionMethod-\u003egetName(); $methodAnnotations = $reader-\u003egetMethodAnnotations($reflectionMethod); if (!empty($methodAnnotations)) { $oneClassAnnotation['methods'][$methodName]['annotation'] = $methodAnnotations; $oneClassAnnotation['methods'][$methodName]['reflection'] = $reflectionMethod; } } $parentReflectionClass = $reflectionClass-\u003egetParentClass(); if ($parentReflectionClass !== false) { $parentClassAnnotation = $this-\u003eparseOneClassAnnotation($parentReflectionClass); if (!empty($parentClassAnnotation)) { $oneClassAnnotation['parent'] = $parentClassAnnotation; } } return $oneClassAnnotation; } 这里就是解析注解了，可以看到分别有类注解、属性注解和方法注解三类。\n这里注意这一段代码。\n// Register annotation parser foreach ($classAnnotations as $classAnnotation) { if ($classAnnotation instanceof AnnotationParser) { $this-\u003eregisterParser($className, $classAnnotation); return []; } } 遍历注解类，如果注解属于AnnotationParser实例，这里调用registerParser进行注册。\n/** * @param string $annotationClass * @param string $parserClassName */ public static function registerParser(string $annotationClass, string $parserClassName): void { self::$classStats['parser']++; self::$parsers[$annotationClass] = $parserClassName; } 回到上一个方法，解析完后，又调用了AnnotationRegister类的registerAnnotation方法进行注册。\n/** * @param string $loadNamespace * @param string $className * @param array $classAnnotation */ public static function registerAnnotation(string $loadNamespace, string $className, array $classAnnotation): void { self::$classStats['annotation']++; self::$annotations[$loadNamespace][$className] = $classAnnotation; } 至此，整个AnnotationProcessor加载完毕，这里AnnotationRegister类里会有annotations和parsers两个属性，这个信息在后面的BeanProcessor里还会用到。\n","wordCount":"1656","inLanguage":"en","datePublished":"2019-08-29T19:11:04+08:00","dateModified":"2019-08-29T19:11:04+08:00","author":{"@type":"Person","name":"Liudon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://liudon.com/posts/swoft-anaotion-processor-analysis/"},"publisher":{"@type":"Organization","name":"流动","logo":{"@type":"ImageObject","url":"https://liudon.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://liudon.com/ accesskey=h title="流动 (Alt + H)">流动</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://liudon.com/ title=Home><span>Home</span></a></li><li><a href=https://liudon.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://workout.liudon.com title=Workouts><span>Workouts</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://liudon.com/about/ title=About><span>About</span></a></li><li><a href=https://liudon.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Swoft 框架运行分析（二） —— AnnotationProcessor模块分析</h1><div class=post-meta><span title='2019-08-29 19:11:04 +0800 +0800'>2019-08-29</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;1656 words&nbsp;·&nbsp;Liudon</div></header><div class=post-content><p>上一篇介绍了，<code>SwoftApplication</code>里定义了6个Processor对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>protected function processors(): array
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        return [
</span></span><span style=display:flex><span>            new EnvProcessor($this),
</span></span><span style=display:flex><span>            new ConfigProcessor($this),
</span></span><span style=display:flex><span>            new AnnotationProcessor($this),
</span></span><span style=display:flex><span>            new BeanProcessor($this),
</span></span><span style=display:flex><span>            new EventProcessor($this),
</span></span><span style=display:flex><span>            new ConsoleProcessor($this),
</span></span><span style=display:flex><span>        ];
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>所有的Processor实现都在<code>framework\src\Processor</code>目录下。</p><ol><li><p>EnvProcessor，运行环境检查。</p></li><li><p>ConfigProcessor，配置相关。</p></li><li><p>AnnotationProcessor，注解相关。</p></li><li><p>BeanProcessor，Bean相关。</p></li><li><p>EventProcessor，事件相关。</p></li><li><p>ConsoleProcessor，命令行输入相关。</p></li></ol><p>今天先讲一下<code>AnnotationProcessor</code>这个模块的实现。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>&lt;</span><span style=color:#960050;background-color:#1e0010>?</span>php declare(strict_types<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>namespace Swoft\Processor;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>use Exception;
</span></span><span style=display:flex><span>use Swoft\Annotation\AnnotationRegister;
</span></span><span style=display:flex><span>use Swoft\Log\Helper\CLog;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> Annotation processor
</span></span><span style=display:flex><span> <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>since <span style=color:#ae81ff>2.0</span>
</span></span><span style=display:flex><span> <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> AnnotationProcessor <span style=color:#66d9ef>extends</span> Processor
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> Handle annotation
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>return</span> <span style=color:#a6e22e>bool</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws Exception
</span></span><span style=display:flex><span>     <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>    public function handle(): <span style=color:#a6e22e>bool</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!$</span>this<span style=color:#f92672>-&gt;</span>application<span style=color:#f92672>-&gt;</span>beforeAnnotation()) {
</span></span><span style=display:flex><span>            CLog::warning(<span style=color:#e6db74>&#39;Stop annotation processor by beforeAnnotation return false&#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> false;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>$</span>app <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>application;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>//</span> Find AutoLoader classes<span style=color:#f92672>.</span> Parse <span style=color:#f92672>and</span> collect annotations<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>        AnnotationRegister::load([
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;inPhar&#39;</span>               <span style=color:#f92672>=&gt;</span> \IN_PHAR,
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;basePath&#39;</span>             <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>$</span>app<span style=color:#f92672>-&gt;</span>getBasePath(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;notifyHandler&#39;</span>        <span style=color:#f92672>=&gt;</span> [<span style=color:#f92672>$</span>this, <span style=color:#e6db74>&#39;notifyHandler&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;disabledAutoLoaders&#39;</span>  <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>$</span>app<span style=color:#f92672>-&gt;</span>getDisabledAutoLoaders(),
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;disabledPsr4Prefixes&#39;</span> <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>$</span>app<span style=color:#f92672>-&gt;</span>getDisabledPsr4Prefixes(),
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>$</span>stats <span style=color:#f92672>=</span> AnnotationRegister::getClassStats();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        CLog::info(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;Annotations is scanned(autoloader </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, annotation </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>, parser </span><span style=color:#e6db74>%d</span><span style=color:#e6db74>)&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>stats[<span style=color:#e6db74>&#39;autoloader&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>stats[<span style=color:#e6db74>&#39;annotation&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>stats[<span style=color:#e6db74>&#39;parser&#39;</span>]
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>application<span style=color:#f92672>-&gt;</span>afterAnnotation();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param string <span style=color:#f92672>$</span>type
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param string <span style=color:#f92672>$</span>target
</span></span><span style=display:flex><span>     <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>see \Swoft\Annotation\<span style=color:#a6e22e>Resource</span>\AnnotationResource::load()
</span></span><span style=display:flex><span>     <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>    public function notifyHandler(string <span style=color:#f92672>$</span>type, <span style=color:#f92672>$</span>target): void
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>switch</span> (<span style=color:#f92672>$</span>type) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;excludeNs&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;Exclude namespace </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;noLoaderFile&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;No autoloader on </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;noLoaderClass&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;Autoloader class not exist </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;findLoaderClass&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;Find autoloader </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;addLoaderClass&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;Parse autoloader </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;noExistClass&#39;</span>:
</span></span><span style=display:flex><span>                CLog::debug(<span style=color:#e6db74>&#39;Skip interface or trait </span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>target);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>核心逻辑调用<code>AnnotationRegister</code>类的<code>load</code>方法，定义如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> Load annotation <span style=color:#66d9ef>class</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param array <span style=color:#f92672>$</span>config
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws AnnotationException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws ReflectionException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>public <span style=color:#66d9ef>static</span> function load(array <span style=color:#f92672>$</span>config <span style=color:#f92672>=</span> []): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>$</span>resource <span style=color:#f92672>=</span> new AnnotationResource(<span style=color:#f92672>$</span>config);
</span></span><span style=display:flex><span>    <span style=color:#f92672>$</span>resource<span style=color:#f92672>-&gt;</span>load();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里又调用了<code>AnnotationResource</code>类的<code>load</code>方法，定义如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> Load annotation resource by find ClassLoader
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws AnnotationException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws ReflectionException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>public function load(): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>$</span>prefixDirsPsr4 <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>classLoader<span style=color:#f92672>-&gt;</span>getPrefixesPsr4();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    foreach (<span style=color:#f92672>$</span>prefixDirsPsr4 as <span style=color:#f92672>$</span>ns <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>$</span>paths) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>//</span> Only scan namespaces
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>onlyNamespaces <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>!</span>in_array(<span style=color:#f92672>$</span>ns, <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>onlyNamespaces, true)) {
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;excludeNs&#39;</span>, <span style=color:#f92672>$</span>ns);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>//</span> It is excluded psr4 prefix
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>isExcludedPsr4Prefix(<span style=color:#f92672>$</span>ns)) {
</span></span><span style=display:flex><span>            AnnotationRegister::registerExcludeNs(<span style=color:#f92672>$</span>ns);
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;excludeNs&#39;</span>, <span style=color:#f92672>$</span>ns);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>//</span> Find package<span style=color:#f92672>/</span>component loader <span style=color:#66d9ef>class</span>
</span></span><span style=display:flex><span>        foreach (<span style=color:#f92672>$</span>paths as <span style=color:#f92672>$</span>path) {
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>loaderFile <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>getAnnotationClassLoaderFile(<span style=color:#f92672>$</span>path);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>file_exists(<span style=color:#f92672>$</span>loaderFile)) {
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;noLoaderFile&#39;</span>, <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>clearBasePath(<span style=color:#f92672>$</span>path), <span style=color:#f92672>$</span>loaderFile);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>loaderClass <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>getAnnotationLoaderClassName(<span style=color:#f92672>$</span>ns);
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>class_exists(<span style=color:#f92672>$</span>loaderClass)) {
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;noLoaderClass&#39;</span>, <span style=color:#f92672>$</span>loaderClass);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>loaderObject <span style=color:#f92672>=</span> new <span style=color:#f92672>$</span>loaderClass();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!$</span>loaderObject instanceof LoaderInterface) {
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;invalidLoader&#39;</span>, <span style=color:#f92672>$</span>loaderFile);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;findLoaderClass&#39;</span>, <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>clearBasePath(<span style=color:#f92672>$</span>loaderFile));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> If is disable, will skip scan annotation classes
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>isset(<span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>disabledAutoLoaders[<span style=color:#f92672>$</span>loaderClass])) {
</span></span><span style=display:flex><span>                AnnotationRegister::registerAutoLoaderFile(<span style=color:#f92672>$</span>loaderFile);
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;addLoaderClass&#39;</span>, <span style=color:#f92672>$</span>loaderClass);
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>loadAnnotation(<span style=color:#f92672>$</span>loaderObject);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> Storage auto loader to register
</span></span><span style=display:flex><span>            AnnotationRegister::addAutoLoader(<span style=color:#f92672>$</span>ns, <span style=color:#f92672>$</span>loaderObject);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通过<code>getPrefixesPsr4</code>方法获取所有自动加载的命名空间和目录，遍历目录下的<code>AutoLoader.php</code>文件。</p><p>通过<code>registerAutoLoaderFile</code>注册自动加载文件到<code>AnnotationRegister</code>对象上。</p><p>然后调用了<code>loadAnnotation</code>方法，传入的是一个<code>autoload</code>对象。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> Load annotations from an component loader config<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param LoaderInterface <span style=color:#f92672>$</span>loader
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws AnnotationException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>throws ReflectionException
</span></span><span style=display:flex><span>    <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>private function loadAnnotation(LoaderInterface <span style=color:#f92672>$</span>loader): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>$</span>nsPaths <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>loader<span style=color:#f92672>-&gt;</span>getPrefixDirs();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    foreach (<span style=color:#f92672>$</span>nsPaths as <span style=color:#f92672>$</span>ns <span style=color:#f92672>=&gt;</span> <span style=color:#f92672>$</span>path) {
</span></span><span style=display:flex><span>        <span style=color:#f92672>$</span>iterator <span style=color:#f92672>=</span> DirectoryHelper::recursiveIterator(<span style=color:#f92672>$</span>path);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>/*</span> <span style=color:#960050;background-color:#1e0010>@</span><span style=color:#66d9ef>var</span> SplFileInfo <span style=color:#f92672>$</span>splFileInfo <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>        foreach (<span style=color:#f92672>$</span>iterator as <span style=color:#f92672>$</span>splFileInfo) {
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>filePath <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>splFileInfo<span style=color:#f92672>-&gt;</span>getPathname();
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> <span style=color:#f92672>$</span>splFileInfo<span style=color:#f92672>-&gt;</span>isDir();
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (is_dir(<span style=color:#f92672>$</span>filePath)) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>fileName  <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>splFileInfo<span style=color:#f92672>-&gt;</span>getFilename();
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>extension <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>splFileInfo<span style=color:#f92672>-&gt;</span>getExtension();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>loaderClassSuffix <span style=color:#f92672>!==</span> <span style=color:#f92672>$</span>extension <span style=color:#f92672>||</span> strpos(<span style=color:#f92672>$</span>fileName, <span style=color:#e6db74>&#39;.&#39;</span>) <span style=color:#f92672>===</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> It is exclude filename
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (isset(<span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>excludedFilenames[<span style=color:#f92672>$</span>fileName])) {
</span></span><span style=display:flex><span>                AnnotationRegister::registerExcludeFilename(<span style=color:#f92672>$</span>fileName);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>suffix    <span style=color:#f92672>=</span> sprintf(<span style=color:#e6db74>&#39;.</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>loaderClassSuffix);
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>pathName  <span style=color:#f92672>=</span> str_replace([<span style=color:#f92672>$</span>path, <span style=color:#e6db74>&#39;/&#39;</span>, <span style=color:#f92672>$</span>suffix], [<span style=color:#e6db74>&#39;&#39;</span>, <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;&#39;</span>], <span style=color:#f92672>$</span>filePath);
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>className <span style=color:#f92672>=</span> sprintf(<span style=color:#e6db74>&#39;</span><span style=color:#e6db74>%s%s</span><span style=color:#e6db74>&#39;</span>, <span style=color:#f92672>$</span>ns, <span style=color:#f92672>$</span>pathName);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> Fix repeat included file bug
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>autoload <span style=color:#f92672>=</span> in_array(<span style=color:#f92672>$</span>filePath, <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>includedFiles, true);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> Will filtering: interfaces <span style=color:#f92672>and</span> traits
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>class_exists(<span style=color:#f92672>$</span>className, <span style=color:#f92672>!$</span>autoload)) {
</span></span><span style=display:flex><span>                <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>notify(<span style=color:#e6db74>&#39;noExistClass&#39;</span>, <span style=color:#f92672>$</span>className);
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#f92672>//</span> Parse annotation
</span></span><span style=display:flex><span>            <span style=color:#f92672>$</span>this<span style=color:#f92672>-&gt;</span>parseAnnotation(<span style=color:#f92672>$</span>ns, <span style=color:#f92672>$</span>className);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>通过getPrefixDirs获取当前命名空间的目录，然后通过<code>recursiveIterator</code>遍历目录下的文件。</p><p>排除目录和非<code>.php</code>结尾的文件，最后会调用<code>parseAnnotation</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/**
</span></span><span style=display:flex><span>    * Parser annotation
</span></span><span style=display:flex><span>    *
</span></span><span style=display:flex><span>    * @param string $namespace
</span></span><span style=display:flex><span>    * @param string $className
</span></span><span style=display:flex><span>    *
</span></span><span style=display:flex><span>    * @throws AnnotationException
</span></span><span style=display:flex><span>    * @throws ReflectionException
</span></span><span style=display:flex><span>    */
</span></span><span style=display:flex><span>private function parseAnnotation(string $namespace, string $className): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    // Annotation reader
</span></span><span style=display:flex><span>    $reflectionClass = new ReflectionClass($className);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // Fix ignore abstract
</span></span><span style=display:flex><span>    if ($reflectionClass-&gt;isAbstract()) {
</span></span><span style=display:flex><span>        return;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    $oneClassAnnotation = $this-&gt;parseOneClassAnnotation($reflectionClass);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    if (!empty($oneClassAnnotation)) {
</span></span><span style=display:flex><span>        AnnotationRegister::registerAnnotation($namespace, $className, $oneClassAnnotation);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里调用了<code>parseOneClassAnnotation</code>方法。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/**
</span></span><span style=display:flex><span>    * Parse an class annotation
</span></span><span style=display:flex><span>    *
</span></span><span style=display:flex><span>    * @param ReflectionClass $reflectionClass
</span></span><span style=display:flex><span>    *
</span></span><span style=display:flex><span>    * @return array
</span></span><span style=display:flex><span>    * @throws AnnotationException
</span></span><span style=display:flex><span>    * @throws ReflectionException
</span></span><span style=display:flex><span>    */
</span></span><span style=display:flex><span>private function parseOneClassAnnotation(ReflectionClass $reflectionClass): array
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    // Annotation reader
</span></span><span style=display:flex><span>    $reader    = new AnnotationReader();
</span></span><span style=display:flex><span>    $className = $reflectionClass-&gt;getName();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $oneClassAnnotation = [];
</span></span><span style=display:flex><span>    $classAnnotations   = $reader-&gt;getClassAnnotations($reflectionClass);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // Register annotation parser
</span></span><span style=display:flex><span>    foreach ($classAnnotations as $classAnnotation) {
</span></span><span style=display:flex><span>        if ($classAnnotation instanceof AnnotationParser) {
</span></span><span style=display:flex><span>            $this-&gt;registerParser($className, $classAnnotation);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            return [];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // Class annotation
</span></span><span style=display:flex><span>    if (!empty($classAnnotations)) {
</span></span><span style=display:flex><span>        $oneClassAnnotation[&#39;annotation&#39;] = $classAnnotations;
</span></span><span style=display:flex><span>        $oneClassAnnotation[&#39;reflection&#39;] = $reflectionClass;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // Property annotation
</span></span><span style=display:flex><span>    $reflectionProperties = $reflectionClass-&gt;getProperties();
</span></span><span style=display:flex><span>    foreach ($reflectionProperties as $reflectionProperty) {
</span></span><span style=display:flex><span>        $propertyName        = $reflectionProperty-&gt;getName();
</span></span><span style=display:flex><span>        $propertyAnnotations = $reader-&gt;getPropertyAnnotations($reflectionProperty);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        if (!empty($propertyAnnotations)) {
</span></span><span style=display:flex><span>            $oneClassAnnotation[&#39;properties&#39;][$propertyName][&#39;annotation&#39;] = $propertyAnnotations;
</span></span><span style=display:flex><span>            $oneClassAnnotation[&#39;properties&#39;][$propertyName][&#39;reflection&#39;] = $reflectionProperty;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    // Method annotation
</span></span><span style=display:flex><span>    $reflectionMethods = $reflectionClass-&gt;getMethods();
</span></span><span style=display:flex><span>    foreach ($reflectionMethods as $reflectionMethod) {
</span></span><span style=display:flex><span>        $methodName        = $reflectionMethod-&gt;getName();
</span></span><span style=display:flex><span>        $methodAnnotations = $reader-&gt;getMethodAnnotations($reflectionMethod);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        if (!empty($methodAnnotations)) {
</span></span><span style=display:flex><span>            $oneClassAnnotation[&#39;methods&#39;][$methodName][&#39;annotation&#39;] = $methodAnnotations;
</span></span><span style=display:flex><span>            $oneClassAnnotation[&#39;methods&#39;][$methodName][&#39;reflection&#39;] = $reflectionMethod;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    $parentReflectionClass = $reflectionClass-&gt;getParentClass();
</span></span><span style=display:flex><span>    if ($parentReflectionClass !== false) {
</span></span><span style=display:flex><span>        $parentClassAnnotation = $this-&gt;parseOneClassAnnotation($parentReflectionClass);
</span></span><span style=display:flex><span>        if (!empty($parentClassAnnotation)) {
</span></span><span style=display:flex><span>            $oneClassAnnotation[&#39;parent&#39;] = $parentClassAnnotation;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    return $oneClassAnnotation;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里就是解析注解了，可以看到分别有类注解、属性注解和方法注解三类。</p><p>这里注意这一段代码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// Register annotation parser
</span></span><span style=display:flex><span>foreach ($classAnnotations as $classAnnotation) {
</span></span><span style=display:flex><span>    if ($classAnnotation instanceof AnnotationParser) {
</span></span><span style=display:flex><span>        $this-&gt;registerParser($className, $classAnnotation);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        return [];
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>遍历注解类，如果注解属于<code>AnnotationParser</code>实例，这里调用<code>registerParser</code>进行注册。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>/**
</span></span><span style=display:flex><span>    * @param string $annotationClass
</span></span><span style=display:flex><span>    * @param string $parserClassName
</span></span><span style=display:flex><span>    */
</span></span><span style=display:flex><span>public static function registerParser(string $annotationClass, string $parserClassName): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    self::$classStats[&#39;parser&#39;]++;
</span></span><span style=display:flex><span>    self::$parsers[$annotationClass] = $parserClassName;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>回到上一个方法，解析完后，又调用了<code>AnnotationRegister</code>类的<code>registerAnnotation</code>方法进行注册。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript3 data-lang=gdscript3><span style=display:flex><span><span style=color:#f92672>/**</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param string <span style=color:#f92672>$</span>loadNamespace
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param string <span style=color:#f92672>$</span>className
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span> <span style=color:#960050;background-color:#1e0010>@</span>param array  <span style=color:#f92672>$</span>classAnnotation
</span></span><span style=display:flex><span>    <span style=color:#f92672>*/</span>
</span></span><span style=display:flex><span>public <span style=color:#66d9ef>static</span> function registerAnnotation(string <span style=color:#f92672>$</span>loadNamespace, string <span style=color:#f92672>$</span>className, array <span style=color:#f92672>$</span>classAnnotation): void
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    self::<span style=color:#f92672>$</span>classStats[<span style=color:#e6db74>&#39;annotation&#39;</span>]<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span>    self::<span style=color:#f92672>$</span>annotations[<span style=color:#f92672>$</span>loadNamespace][<span style=color:#f92672>$</span>className] <span style=color:#f92672>=</span> <span style=color:#f92672>$</span>classAnnotation;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>至此，整个<code>AnnotationProcessor</code>加载完毕，这里<code>AnnotationRegister</code>类里会有<code>annotations</code>和<code>parsers</code>两个属性，这个信息在后面的<code>BeanProcessor</code>里还会用到。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://liudon.com/tags/swoft/>Swoft</a></li></ul><nav class=paginav><a class=prev href=https://liudon.com/posts/swoft-bean-processor-analysis/><span class=title>« Prev</span><br><span>Swoft 框架运行分析（三） —— BeanProcessor模块分析</span>
</a><a class=next href=https://liudon.com/posts/swoft-execution-analysis/><span class=title>Next »</span><br><span>Swoft 框架运行分析（一）</span></a></nav></footer><div><div class=post_ads><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4739645989170648 data-ad-slot=5019102040 data-ad-format=auto data-full-width-responsive=true></ins><script>window.addEventListener("load",function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script></div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdnjs.cloudflare.com/ajax/libs/twikoo/1.6.41/twikoo.all.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script>twikoo.init({envId:"https://comment.liudon.com",el:"#tcomment",lang:"zh-CN",region:"ap-shanghai",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://liudon.com/>流动</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer style=margin-top:-20px;padding-top:0><span><a href=https://beian.miit.gov.cn target=_blank>京ICP备13029522号-2</a></span></footer><script src=//tokinx.github.io/ViewImage/view-image.min.js async></script><script>function initViewImage(){window.ViewImage&&ViewImage.init(".post-content img")}document.readyState==="complete"?initViewImage():window.addEventListener("load",initViewImage)</script><script>const host=window.location.host;host!=="blog.liudon.xyz"&&!host.startsWith("liudon.")&&!host.startsWith("localhost")&&!host.startsWith("127.0.0.1")&&(document.body.innerHTML=['<div style="margin: auto;">',"<h1>当前页面并非本人博客，即将在2秒后跳转到本人博客: https://liudon.com。</h1>","<br />","</div>"].join(""),document.body.style=["background-color: white;","color: black;","text-align: center;","font-size: 50px;","width: 100vw;","height: 100vh;","display: flex;"].join(""),setTimeout(()=>{window.location.href="https://liudon.com"},2e3))</script><script>enScroll=!1,enFdl=!1,extCurrent=0[0],filename=0[0],targetText=0[0],splitOrigin=0[0];const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-G9ZDJQN9E2",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?0[0]:enScroll==!0?0[0]:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return 0[0]},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":0[0],C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return 0[0]},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==0[0]&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://liudon.com/analytics/post",M=k({tid:j,_p:F(),v:"2",sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||0[0]).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||0[0],dr:doc.referrer||0[0],sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||0[0],"ep.file_name":t||0[0],"ep.link_text":n||0[0],"ep.link_url":o||0[0],_ss:O(),_dbg:A?1:0[0]}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>