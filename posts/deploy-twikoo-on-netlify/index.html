<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>在Netlify上部署Twikoo评论系统 | 流动</title><meta name=keywords content="netlify,twikoo,github,vercel,hugo"><meta name=description content="
在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。
2024年7月30日更新：因为Github接口策略调整，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。"><meta name=author content="Liudon"><link rel=canonical href=https://liudon.com/posts/deploy-twikoo-on-netlify/><link crossorigin=anonymous href=../../assets/css/stylesheet.c2b4102602461aaea01497bf2f89d3d4096e9005f6ac8a7e60b27e335724b916.css integrity="sha256-wrQQJgJGGq6gFJe/L4nT1AlukAX2rIp+YLJ+M1ckuRY=" rel="preload stylesheet" as=style><link rel=icon href=https://liudon.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://liudon.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://liudon.com/favicon-32x32.png><link rel=apple-touch-icon href=https://liudon.com/apple-touch-icon.png><link rel=mask-icon href=https://liudon.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://liudon.com/posts/deploy-twikoo-on-netlify/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta name=google-site-verification content="rJrwFlRtYvRvSMxmD-zlGY6ozg6aDFMkfavno3ms5Ew"><meta name=google-adsense-account content="ca-pub-4739645989170648"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4739645989170648" crossorigin=anonymous></script><meta property="og:url" content="https://liudon.com/posts/deploy-twikoo-on-netlify/"><meta property="og:site_name" content="流动"><meta property="og:title" content="在Netlify上部署Twikoo评论系统"><meta property="og:description" content=" 在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。
2024年7月30日更新：因为Github接口策略调整，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-10-19T19:46:32+08:00"><meta property="article:modified_time" content="2023-10-19T19:46:32+08:00"><meta property="article:tag" content="Netlify"><meta property="article:tag" content="Twikoo"><meta property="article:tag" content="Github"><meta property="article:tag" content="Vercel"><meta property="article:tag" content="Hugo"><meta name=twitter:card content="summary"><meta name=twitter:title content="在Netlify上部署Twikoo评论系统"><meta name=twitter:description content="
在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。
2024年7月30日更新：因为Github接口策略调整，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"文章","item":"https://liudon.com/posts/"},{"@type":"ListItem","position":2,"name":"在Netlify上部署Twikoo评论系统","item":"https://liudon.com/posts/deploy-twikoo-on-netlify/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"在Netlify上部署Twikoo评论系统","name":"在Netlify上部署Twikoo评论系统","description":" 在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。\n2024年7月30日更新：因为Github接口策略调整，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。\n","keywords":["netlify","twikoo","github","vercel","hugo"],"articleBody":" 在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。\n2024年7月30日更新：因为Github接口策略调整，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。\n背景 博客之前通过Vercel部署了Twikoo评论系统，但是最近发现加载很慢。\n看Twikoo官网文档，Netlify比Vercel国内访问会更优一些，于是搞了一把迁移。\n迁移过程中遇到了一些问题，网上搜了一番，发现Netlify下部署Twikoo的信息很少，这篇文章我会介绍整个操作过程。\n部署 参考官网文档，部署即可。\n这里一开始Fork成了https://github.com/twikoojs/twikoo，导致部署后访问404。\n注意，正确的仓库是https://github.com/twikoojs/twikoo-netlify。\n使用同一个MongoDB，配置原来的地址，这样已有的评论也不会丢。\n部署后，通过https://comment.liudon.com访问，返回200。\n但是访问https://liudon.com，提示CORS跨域错误，搜索一番网上资料也没找到相关信息。\n一般跨域错误都是返回头里缺少跨域相关的字段导致，因此决定使用Netlify来新增返回头规避。\n仓库下新增netlify.toml文件，针对根目录返回跨域头，内容如下。\n[[headers]] # Define which paths this specific [[headers]] block will cover. for = \"/\" [headers.values] Access-Control-Allow-Origin = \"*\" Access-Control-Allow-Headers = \"Content-Type\" Access-Control-Allow-Methods = \"*\" 再次刷新页面，报错又变成了404，但是直接访问https://comment.liudon.com地址是返回的200。\n经过一番定位，发现了问题所在：\ntwikoo-netlify库根目录地址是通过Location跳转到的/.netlify/functions/twikoo接口，/.netlify/functions/twikoo才是真正处理的接口。\n而vercel-netlify库是通过rewrite将所有请求转发到了/api/index接口。\n博客里写的Twikoo环境id填的是https://comment.liudon.com，更换为Netlify后，需要更换环境id，补齐后面的/.netlify/functions/twikoo。\n因为Netlify也支持Rewrite转发，所以决定还是通过netlify.toml文件增加转发配置解决，内容如下：\n[[redirects]] from = \"/\" to = \"/.netlify/functions/twikoo\" status = 200 force = true 注意一定不要漏了force参数，因为根目录文件是存在的，不带这个参数的话Rewrite是不生效的，必须指定这个。\n这下访问彻底ok了。\n不过很快又发现另外一个问题，看到别人博客上Twikoo版本已经是1.6.22，自己的还是1.5.11。\n搜索一番后，Twikoo已经给出了更新操作:\n针对 Netlify 部署的更新方式 1. 登录 Github，找到部署时 fork 到自己账号下的名为 twikoo-netlify 的仓库 2. 打开 package.json，点击编辑 3. 将 \"twikoo-vercel\": \"latest\" 其中的 latest 修改为最新版本号。点击 Commit changes 4. 部署会自动触发 不过这样操作，每次版本更新，都需要手动去改一下package.json文件的版本，重新构建。\n对于一个程序员，我们的追求就是自动化。\n自动版本更新 服务端版本自动更新 这里利用Github Actions定时任务，通过接口拉取twikoo最新的版本，然后更新到package.json文件，从而实现版本自动更新。\n在自己twikoo-netlify仓库下，新增Actions，代码如下：\n# This is a basic workflow to help you get started with Actions name: CI # Controls when the workflow will run on: # Triggers the workflow on push or pull request events but only for the \"main\" branch push: branches: [ \"main\" ] pull_request: branches: [ \"main\" ] # Allows you to run this workflow manually from the Actions tab workflow_dispatch: schedule: - cron: '0 2 * * *' # 每天定时2点执行一次 # A workflow run is made up of one or more jobs that can run sequentially or in parallel jobs: # This workflow contains a single job called \"build\" build: # The type of runner that the job will run on runs-on: ubuntu-latest permissions: contents: write # Steps represent a sequence of tasks that will be executed as part of the job steps: # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it - uses: actions/checkout@v3 # Runs a single command using the runners shell - name: update version env: github_token: ${{ secrets.TOKEN }} run: | response=$(curl -sf -H \"Authorization: token $github_token\" -H \"Accept: application/vnd.github+json\" https://api.github.com/repos/twikoojs/twikoo/releases/latest) version=$(echo $response | jq -r '.tag_name') if [ -n \"$version\" ]; then sed -i \"s/\\\"twikoo-netlify\\\": \\\".*\\\"/\\\"twikoo-netlify\\\": \\\"$version\\\"/\" package.json fi shell: bash # Runs a set of commands using the runners shell - name: Commit changes uses: EndBug/add-and-commit@v9 env: github_token: ${{ secrets.TOKEN }} add: . 这里会把修改后的package.json文件提交到仓库，所以需要申请一个Token，可以参考我上一篇文章申请，然后添加到仓库变量里。\n博客引用版本自动更新 这里一开始想到在前端去查服务端最新版本号，然后引用对应版本的js文件来实现。\n但是这样就会导致每次页面加载都要去查一次版本，会导致加载时间变长。\n因此还是决定在服务端部署时，获取最新版本号更新服务。\n引用版本配置化 comments.html文件修改：\n","wordCount":"2232","inLanguage":"en","datePublished":"2023-10-19T19:46:32+08:00","dateModified":"2023-10-19T19:46:32+08:00","author":{"@type":"Person","name":"Liudon"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://liudon.com/posts/deploy-twikoo-on-netlify/"},"publisher":{"@type":"Organization","name":"流动","logo":{"@type":"ImageObject","url":"https://liudon.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://liudon.com/ accesskey=h title="流动 (Alt + H)">流动</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://liudon.com/ title=Home><span>Home</span></a></li><li><a href=https://liudon.com/posts/ title=Posts><span>Posts</span></a></li><li><a href=https://workout.liudon.com title=Workouts><span>Workouts</span>&nbsp;
<svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/><path d="M15 3h6v6"/><path d="M10 14 21 3"/></svg></a></li><li><a href=https://liudon.com/about/ title=About><span>About</span></a></li><li><a href=https://liudon.com/search/ title="🔍 (Alt + /)" accesskey=/><span>🔍</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">在Netlify上部署Twikoo评论系统</h1><div class=post-meta><span title='2023-10-19 19:46:32 +0800 +0800'>2023-10-19</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;2232 words&nbsp;·&nbsp;Liudon</div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#%e8%83%8c%e6%99%af aria-label=背景>背景</a></li><li><a href=#%e9%83%a8%e7%bd%b2 aria-label=部署>部署</a></li><li><a href=#%e8%87%aa%e5%8a%a8%e7%89%88%e6%9c%ac%e6%9b%b4%e6%96%b0 aria-label=自动版本更新>自动版本更新</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><blockquote><p>在本篇文章里，我会介绍如何在Netlify上部署Twikoo评论系统，如何接入到静态博客Hugo，以及如何实现Twikoo系统版本自动更新。</p></blockquote><p><em>2024年7月30日更新：因为<a href=https://docs.github.com/rest/overview/resources-in-the-rest-api#rate-limiting>Github接口策略调整</a>，原有的匿名通过接口获取版本号方法失效，已更改为带token方式请求接口获取版本号，详见workflow里Get twikoo version步骤配置。</em></p><h4 id=背景>背景<a hidden class=anchor aria-hidden=true href=#背景>#</a></h4><p>博客之前通过<code>Vercel</code>部署了<code>Twikoo</code>评论系统，但是最近发现加载很慢。</p><p>看<a href=https://twikoo.js.org/backend.html>Twikoo官网文档</a>，<code>Netlify</code>比<code>Vercel</code>国内访问会更优一些，于是搞了一把迁移。</p><p>迁移过程中遇到了一些问题，网上搜了一番，发现<code>Netlify</code>下部署<code>Twikoo</code>的信息很少，这篇文章我会介绍整个操作过程。</p><h4 id=部署>部署<a hidden class=anchor aria-hidden=true href=#部署>#</a></h4><p>参考<a href=https://twikoo.js.org/backend.html#netlify-%E9%83%A8%E7%BD%B2>官网文档</a>，部署即可。</p><p>这里一开始Fork成了<code>https://github.com/twikoojs/twikoo</code>，导致部署后访问404。</p><p>注意，正确的仓库是<code>https://github.com/twikoojs/twikoo-netlify</code>。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/netlify-3.4f565e5d.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/netlify-3.4f565e5d.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=netlify-3.4f565e5d.png width=1080 height=520 alt=Netlify部署Twikoo title loading=lazy></picture></p><p>使用同一个<code>MongoDB</code>，配置原来的地址，这样已有的评论也不会丢。</p><p>部署后，通过<code>https://comment.liudon.com</code>访问，返回200。</p><p>但是访问<code>https://liudon.com</code>，提示<code>CORS跨域错误</code>，搜索一番网上资料也没找到相关信息。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019190935.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019190935.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20231019190935.png width=1080 height=309 alt=CORS报错 title loading=lazy></picture></p><p>一般跨域错误都是返回头里缺少跨域相关的字段导致，因此决定使用<code>Netlify</code>来新增返回头规避。</p><p>仓库下新增<code>netlify.toml</code>文件，针对根目录返回跨域头，内容如下。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[[headers]]
</span></span><span style=display:flex><span>  # Define which paths this specific [[headers]] block will cover.
</span></span><span style=display:flex><span>  for = &#34;/&#34;
</span></span><span style=display:flex><span>    [headers.values]
</span></span><span style=display:flex><span>    Access-Control-Allow-Origin = &#34;*&#34;
</span></span><span style=display:flex><span>    Access-Control-Allow-Headers = &#34;Content-Type&#34;
</span></span><span style=display:flex><span>    Access-Control-Allow-Methods = &#34;*&#34;
</span></span></code></pre></div><p>再次刷新页面，报错又变成了404，但是直接访问<code>https://comment.liudon.com</code>地址是返回的200。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191326.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191326.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20231019191326.png width=1080 height=263 alt=404报错 title loading=lazy></picture></p><p>经过一番定位，发现了问题所在：</p><p><code>twikoo-netlify</code>库根目录地址是通过<code>Location</code>跳转到的<code>/.netlify/functions/twikoo</code>接口，<code>/.netlify/functions/twikoo</code>才是真正处理的接口。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191522.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191522.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20231019191522.png width=1080 height=284 alt=twikoo-netlify根目录返回 title loading=lazy></picture></p><p>而<code>vercel-netlify</code>库是通过rewrite将所有请求转发到了<code>/api/index</code>接口。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191833.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019191833.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20231019191833.png width=1012 height=442 alt=twikoo-vercel转发 title loading=lazy></picture></p><p>博客里写的<code>Twikoo</code>环境id填的是<code>https://comment.liudon.com</code>，更换为<code>Netlify</code>后，需要更换环境id，补齐后面的<code>/.netlify/functions/twikoo</code>。</p><p><picture><source type=image/avif srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019192158.png_1080x.avif 1080w" sizes="(min-width: 768px) 1080px, 100vw"><source type=image/webp srcset="https://liudon.com/posts/deploy-twikoo-on-netlify/20231019192158.png_1080x.webp 1080w" sizes="(min-width: 768px) 1080px, 100vw"><img src=20231019192158.png width=663 height=137 alt=twikoo环境id title loading=lazy></picture></p><p>因为<code>Netlify</code>也支持<code>Rewrite</code>转发，所以决定还是通过<code>netlify.toml</code>文件增加转发配置解决，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>[[redirects]]
</span></span><span style=display:flex><span>  from = &#34;/&#34;
</span></span><span style=display:flex><span>  to = &#34;/.netlify/functions/twikoo&#34;
</span></span><span style=display:flex><span>  status = 200
</span></span><span style=display:flex><span>  force = true
</span></span></code></pre></div><p>注意一定不要漏了<code>force</code>参数，因为根目录文件是存在的，不带这个参数的话<code>Rewrite</code>是不生效的，必须指定这个。</p><p>这下访问彻底ok了。</p><p>不过很快又发现另外一个问题，看到别人博客上<code>Twikoo</code>版本已经是<code>1.6.22</code>，自己的还是<code>1.5.11</code>。</p><p>搜索一番后，<code>Twikoo</code>已经给出了更新操作:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>针对 Netlify 部署的更新方式
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1. 登录 Github，找到部署时 fork 到自己账号下的名为 twikoo-netlify 的仓库
</span></span><span style=display:flex><span>2. 打开 package.json，点击编辑
</span></span><span style=display:flex><span>3. 将 &#34;twikoo-vercel&#34;: &#34;latest&#34; 其中的 latest 修改为最新版本号。点击 Commit changes
</span></span><span style=display:flex><span>4. 部署会自动触发
</span></span></code></pre></div><p>不过这样操作，每次版本更新，都需要手动去改一下<code>package.json</code>文件的版本，重新构建。</p><p>对于一个程序员，我们的追求就是自动化。</p><h4 id=自动版本更新>自动版本更新<a hidden class=anchor aria-hidden=true href=#自动版本更新>#</a></h4><ol><li>服务端版本自动更新</li></ol><p>这里利用<code>Github Actions</code>定时任务，通过接口拉取<a href=https://github.com/twikoojs/twikoo/releases>twikoo</a>最新的版本，然后更新到<code>package.json</code>文件，从而实现版本自动更新。</p><p>在自己<code>twikoo-netlify</code>仓库下，新增<code>Actions</code>，代码如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span># This is a basic workflow to help you get started with Actions
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>name: CI
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Controls when the workflow will run
</span></span><span style=display:flex><span>on:
</span></span><span style=display:flex><span>  # Triggers the workflow on push or pull request events but only for the &#34;main&#34; branch
</span></span><span style=display:flex><span>  push:
</span></span><span style=display:flex><span>    branches: [ &#34;main&#34; ]
</span></span><span style=display:flex><span>  pull_request:
</span></span><span style=display:flex><span>    branches: [ &#34;main&#34; ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  # Allows you to run this workflow manually from the Actions tab
</span></span><span style=display:flex><span>  workflow_dispatch:
</span></span><span style=display:flex><span>  schedule:
</span></span><span style=display:flex><span>    - cron: &#39;0 2 * * *&#39; # 每天定时2点执行一次
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># A workflow run is made up of one or more jobs that can run sequentially or in parallel
</span></span><span style=display:flex><span>jobs:
</span></span><span style=display:flex><span>  # This workflow contains a single job called &#34;build&#34;
</span></span><span style=display:flex><span>  build:
</span></span><span style=display:flex><span>    # The type of runner that the job will run on
</span></span><span style=display:flex><span>    runs-on: ubuntu-latest
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    permissions:      
</span></span><span style=display:flex><span>      contents: write
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    # Steps represent a sequence of tasks that will be executed as part of the job
</span></span><span style=display:flex><span>    steps:
</span></span><span style=display:flex><span>      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
</span></span><span style=display:flex><span>      - uses: actions/checkout@v3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      # Runs a single command using the runners shell
</span></span><span style=display:flex><span>      - name: update version
</span></span><span style=display:flex><span>        env:
</span></span><span style=display:flex><span>          github_token: ${{ secrets.TOKEN }}
</span></span><span style=display:flex><span>        run: |
</span></span><span style=display:flex><span>          response=$(curl -sf -H &#34;Authorization: token $github_token&#34; -H &#34;Accept: application/vnd.github+json&#34; https://api.github.com/repos/twikoojs/twikoo/releases/latest)
</span></span><span style=display:flex><span>          version=$(echo $response | jq -r &#39;.tag_name&#39;)
</span></span><span style=display:flex><span>          if [ -n &#34;$version&#34; ]; then
</span></span><span style=display:flex><span>            sed -i &#34;s/\&#34;twikoo-netlify\&#34;: \&#34;.*\&#34;/\&#34;twikoo-netlify\&#34;: \&#34;$version\&#34;/&#34; package.json
</span></span><span style=display:flex><span>          fi
</span></span><span style=display:flex><span>        shell: bash
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>      # Runs a set of commands using the runners shell
</span></span><span style=display:flex><span>      - name: Commit changes
</span></span><span style=display:flex><span>        uses: EndBug/add-and-commit@v9
</span></span><span style=display:flex><span>        env:
</span></span><span style=display:flex><span>          github_token: ${{ secrets.TOKEN }}
</span></span><span style=display:flex><span>          add: .
</span></span></code></pre></div><p>这里会把修改后的<code>package.json</code>文件提交到仓库，所以需要申请一个<code>Token</code>，可以参考我上一篇<a href=https://liudon.com/posts/using-github-actions-to-schedule-weibo-scraping/>文章</a>申请，然后添加到仓库变量里。</p><ol start=2><li>博客引用版本自动更新</li></ol><p>这里一开始想到在前端去查服务端最新版本号，然后引用对应版本的js文件来实现。</p><p>但是这样就会导致每次页面加载都要去查一次版本，会导致加载时间变长。</p><p>因此还是决定在服务端部署时，获取最新版本号更新服务。</p><ul><li>引用版本配置化</li></ul><p><code>comments.html</code>文件修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>&lt;script src=&#34;https://cdn.staticfile.org/twikoo/{{ .Site.Params.twikoo.version }}/twikoo.all.min.js&#34;&gt;
</span></span></code></pre></div><p><code>config.tml</code>配置修改：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>params:
</span></span><span style=display:flex><span>  env: production # to enable google analytics, opengraph, twitter-cards and schema.
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  ... # 其他配置
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  assets:
</span></span><span style=display:flex><span>    disableHLJS: true # to disable highlight.js
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>  twikoo:
</span></span><span style=display:flex><span>    version: 1.5.11 # 配置twikoo版本号
</span></span></code></pre></div><ul><li>获取最新版本号部署</li></ul><p><code>Actions</code>新增步骤：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>    - name: Setup Hugo
</span></span><span style=display:flex><span>    uses: peaceiris/actions-hugo@v2
</span></span><span style=display:flex><span>    with:
</span></span><span style=display:flex><span>        hugo-version: &#39;latest&#39;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ####
</span></span><span style=display:flex><span>    - name: Get twikoo version
</span></span><span style=display:flex><span>    id: twikoo
</span></span><span style=display:flex><span>    run: |
</span></span><span style=display:flex><span>        version=$(curl -s https://raw.githubusercontent.com/Liudon/twikoo-netlify/main/package.json | jq -r &#39;.dependencies.&#34;twikoo-netlify&#34;&#39;)
</span></span><span style=display:flex><span>        echo &#34;Twikoo version: $version&#34;
</span></span><span style=display:flex><span>        echo &#34;twikoo_version=$version&#34; &gt;&gt; $GITHUB_OUTPUT
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    - name: Update config.yml version
</span></span><span style=display:flex><span>    uses: fjogeleit/yaml-update-action@main
</span></span><span style=display:flex><span>    with:
</span></span><span style=display:flex><span>        valueFile: &#39;config.yml&#39;
</span></span><span style=display:flex><span>        propertyPath: &#39;params.twikoo.version&#39;
</span></span><span style=display:flex><span>        value: ${{ steps.twikoo.outputs.twikoo_version }}
</span></span><span style=display:flex><span>        commitChange: true
</span></span><span style=display:flex><span>    ####
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>    - name: Build
</span></span><span style=display:flex><span>    run: hugo --gc --minify --cleanDestinationDir 
</span></span></code></pre></div><p><code>####</code>内代码即为获取版本号，更新<code>config.tml</code>版本号逻辑，然后再进行<code>hugo</code>部署。</p><p>需要将<code>https://raw.githubusercontent.com/Liudon/twikoo-netlify/main/package.json</code>这个url里的<code>Liudon/twikoo-netlify</code>改为你的仓库名。</p><p>这下后面<code>Twikoo</code>官方更新版本，博客的<code>Twikoo</code>也会跟着自动更新。</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://liudon.com/tags/netlify/>Netlify</a></li><li><a href=https://liudon.com/tags/twikoo/>Twikoo</a></li><li><a href=https://liudon.com/tags/github/>Github</a></li><li><a href=https://liudon.com/tags/vercel/>Vercel</a></li><li><a href=https://liudon.com/tags/hugo/>Hugo</a></li></ul><nav class=paginav><a class=prev href=https://liudon.com/posts/how-to-use-google-indexing-api-to-speed-up-blog-indexing/><span class=title>« Prev</span><br><span>使用Google Indexing API加速博客收录</span>
</a><a class=next href=https://liudon.com/posts/using-github-actions-to-schedule-weibo-scraping/><span class=title>Next »</span><br><span>利用Github Actions定时抓取微博</span></a></nav></footer><div><div class=post_ads><ins class=adsbygoogle style=display:block data-ad-client=ca-pub-4739645989170648 data-ad-slot=5019102040 data-ad-format=auto data-full-width-responsive=true></ins><script>window.addEventListener("load",function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script></div><div class=pagination__title><span class=pagination__title-h style=font-size:20px>💬评论</span><hr></div><div id=tcomment></div><script src=https://cdnjs.cloudflare.com/ajax/libs/twikoo/1.6.41/twikoo.all.min.js crossorigin=anonymous referrerpolicy=no-referrer></script><script>twikoo.init({envId:"https://comment.liudon.com",el:"#tcomment",lang:"zh-CN",region:"ap-shanghai",path:window.TWIKOO_MAGIC_PATH||window.location.pathname})</script></div></article></main><footer class=footer><span>&copy; 2025 <a href=https://liudon.com/>流动</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg></a><footer class=footer style=margin-top:-20px;padding-top:0><span><a href=https://beian.miit.gov.cn target=_blank>京ICP备13029522号-2</a></span></footer><script src=//tokinx.github.io/ViewImage/view-image.min.js async></script><script>function initViewImage(){window.ViewImage&&ViewImage.init(".post-content img")}document.readyState==="complete"?initViewImage():window.addEventListener("load",initViewImage)</script><script>const host=window.location.host;host!=="blog.liudon.xyz"&&!host.startsWith("liudon.")&&!host.startsWith("localhost")&&!host.startsWith("127.0.0.1")&&(document.body.innerHTML=['<div style="margin: auto;">',"<h1>当前页面并非本人博客，即将在2秒后跳转到本人博客: https://liudon.com。</h1>","<br />","</div>"].join(""),document.body.style=["background-color: white;","color: black;","text-align: center;","font-size: 50px;","width: 100vw;","height: 100vh;","display: flex;"].join(""),setTimeout(()=>{window.location.href="https://liudon.com"},2e3))</script><script>enScroll=!1,enFdl=!1,extCurrent=0[0],filename=0[0],targetText=0[0],splitOrigin=0[0];const lStor=localStorage,sStor=sessionStorage,doc=document,docEl=document.documentElement,docBody=document.body,docLoc=document.location,w=window,s=screen,nav=navigator||{},extensions=["pdf","xls","xlsx","doc","docx","txt","rtf","csv","exe","key","pps","ppt","pptx","7z","pkg","rar","gz","zip","avi","mov","mp4","mpe","mpeg","wmv","mid","midi","mp3","wav","wma"];function a(e,t,n,o){const j="G-G9ZDJQN9E2",r=()=>Math.floor(Math.random()*1e9)+1,c=()=>Math.floor(Date.now()/1e3),F=()=>(sStor._p||(sStor._p=r()),sStor._p),E=()=>r()+"."+c(),_=()=>(lStor.cid_v4||(lStor.cid_v4=E()),lStor.cid_v4),m=lStor.getItem("cid_v4"),v=()=>m?0[0]:enScroll==!0?0[0]:"1",p=()=>(sStor.sid||(sStor.sid=c()),sStor.sid),O=()=>{if(!sStor._ss)return sStor._ss="1",sStor._ss;if(sStor.getItem("_ss")=="1")return 0[0]},a="1",g=()=>{if(sStor.sct)if(enScroll==!0)return sStor.sct;else x=+sStor.getItem("sct")+ +a,sStor.sct=x;else sStor.sct=a;return sStor.sct},i=docLoc.search,b=new URLSearchParams(i),h=["q","s","search","query","keyword"],y=h.some(e=>i.includes("&"+e+"=")||i.includes("?"+e+"=")),u=()=>y==!0?"view_search_results":enScroll==!0?"scroll":enFdl==!0?"file_download":"page_view",f=()=>enScroll==!0?"90":0[0],C=()=>{if(u()=="view_search_results"){for(let e of b)if(h.includes(e[0]))return e[1]}else return 0[0]},d=encodeURIComponent,k=e=>{let t=[];for(let n in e)e.hasOwnProperty(n)&&e[n]!==0[0]&&t.push(d(n)+"="+d(e[n]));return t.join("&")},A=!1,S="https://liudon.com/analytics/post",M=k({tid:j,_p:F(),v:"2",sr:(s.width*w.devicePixelRatio+"x"+s.height*w.devicePixelRatio).toString(),ul:(nav.language||0[0]).toLowerCase(),cid:_(),_fv:v(),_s:"1",dl:docLoc.origin+docLoc.pathname+i,dt:doc.title||0[0],dr:doc.referrer||0[0],sid:p(),sct:g(),seg:"1",en:u(),"epn.percent_scrolled":f(),"ep.search_term":C(),"ep.file_extension":e||0[0],"ep.file_name":t||0[0],"ep.link_text":n||0[0],"ep.link_url":o||0[0],_ss:O(),_dbg:A?1:0[0]}),l=S+"?"+M;if(nav.sendBeacon)nav.sendBeacon(l);else{let e=new XMLHttpRequest;e.open("POST",l,!0)}}a();function sPr(){return(docEl.scrollTop||docBody.scrollTop)/((docEl.scrollHeight||docBody.scrollHeight)-docEl.clientHeight)*100}doc.addEventListener("scroll",sEv,{passive:!0});function sEv(){const e=sPr();if(e<90)return;enScroll=!0,a(),doc.removeEventListener("scroll",sEv,{passive:!0}),enScroll=!1}document.addEventListener("DOMContentLoaded",function(){let e=document.getElementsByTagName("a");for(let t=0;t<e.length;t++)if(e[t].getAttribute("href")!=null){const n=e[t].getAttribute("href"),s=n.substring(n.lastIndexOf("/")+1),o=s.split(".").pop();(e[t].hasAttribute("download")||extensions.includes(o))&&e[t].addEventListener("click",fDl,{passive:!0})}});function fDl(e){enFdl=!0;const t=e.currentTarget.getAttribute("href"),n=t.substring(t.lastIndexOf("/")+1),s=n.split(".").pop(),o=n.replace("."+s,""),i=e.currentTarget.text,r=t.replace(docLoc.origin,"");a(s,o,i,r),enFdl=!1}</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>